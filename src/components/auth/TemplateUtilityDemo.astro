---
/**
 * Template Utility Demonstration Component
 *
 * Comprehensive showcase of all RBAC template utilities and their usage patterns.
 * Demonstrates conditional rendering, permission checking, and role-based UI adaptation.
 */
import { Button } from '@/components/ui/button';
import { Code } from 'astro:components';
import {
	canWriteContent,
	canEditContent,
	canManageUser,
	hasRole,
	isAdmin,
	hasPermissionTemplate as hasPermission,
	hasAnyPermissionTemplate as hasAnyPermission,
	isAuthenticated,
	getUserRoleTemplate as getUserRole,
	getUserPermissionsTemplate as getUserPermissions,
} from '@/lib/auth';
import type { Permission } from '@/types/auth';

// Get all utility function results for demonstration
const authenticated = isAuthenticated(Astro.locals);
const userRole = getUserRole(Astro.locals);
const userPermissions = getUserPermissions(Astro.locals);

// Individual permission checks
const canWrite = canWriteContent(Astro.locals);
const canEdit = canEditContent(Astro.locals);
const canManage = canManageUser(Astro.locals);

// Role checks
const isUserAdmin = isAdmin(Astro.locals);
const isUserEditor = hasRole(Astro.locals, 'editor');
const isUserViewer = hasRole(Astro.locals, 'viewer');

// Advanced permission checks
const hasWritePermission = hasPermission(Astro.locals, 'write_content');
const hasEditPermission = hasPermission(Astro.locals, 'edit_content');
const hasManagePermission = hasPermission(Astro.locals, 'manage_user');

// Multiple permission checks
const hasContentPermissions = hasAnyPermission(Astro.locals, [
	'write_content',
	'edit_content',
]);
const hasAllPermissions = hasAnyPermission(Astro.locals, [
	'write_content',
	'edit_content',
	'manage_user',
]);

// Demo data for examples
const demoPermissions: Permission[] = [
	'write_content',
	'edit_content',
	'manage_user',
];
---

<div class="w-full">
	<!-- <div
		class="text-center mb-8 p-6 bg-linear-to-br from-blue-500 to-purple-600 text-white"
	>
		<h2 class="text-2xl font-bold mb-2 m-0">
			Template Utility Functions Demonstration
		</h2>
		<p class="m-0 opacity-90">
			Interactive showcase of all RBAC template utilities and their real-time
			results
		</p>
	</div> -->

	{
		!authenticated ? (
			<div class="text-center p-8 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700  text-yellow-800 dark:text-yellow-200">
				<h3 class="text-lg font-semibold mb-2">⚠️ Authentication Required</h3>
				<p class="mb-4">
					Sign in to see the template utilities in action with real user data.
				</p>
				<a
					href="/sign-in"
					class="inline-block mt-4 px-6 py-3 bg-blue-500 dark:bg-blue-600 text-white no-underline rounded font-medium hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors"
				>
					Sign In to Test
				</a>
			</div>
		) : (
			<div class="flex flex-col gap-8">
				{/* Current User Context */}
				<div class="bg-foreground/5 p-6 rounded border">
					<h3 class="text-lg font-semi m-0 mb-4 pb-2">Current User Context</h3>
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
						<div class="bg-foreground/10 p-4 rounded border">
							<strong>Authenticated:</strong>
							<span
								class={`font-bold ${authenticated ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}
							>
								{authenticated ? 'Yes' : 'No'}
							</span>
						</div>
						<div class="bg-foreground/10 p-4 rounded border">
							<strong>Role:</strong>
							<span
								class={`px-2 py-1 rounded text-xs font-bold uppercase text-white ${userRole === 'admin' ? 'bg-destructive' : userRole === 'editor' ? 'bg-green-500' : 'bg-gray-500'}`}
							>
								{userRole}
							</span>
						</div>
						<div class="bg-foreground/10 p-4 rounded border">
							<strong>Permissions:</strong>
							<span class="text-sm flex gap-2">
								{userPermissions.length > 0
									? userPermissions.map((permission) => (
											<code class="rounded font-mono bg-foreground/10 px-1">
												{permission}
											</code>
										))
									: 'None'}
							</span>
						</div>
					</div>
				</div>

				{/* Permission Checking Utilities */}
				<div class="bg-foreground/5 p-6 rounded border">
					<h3 class="text-lg font-semi m-0 mb-4 pb-2">
						Permission Checking Utilities
					</h3>
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
						<div class="bg-foreground/10 p-4 rounded border">
							<h4 class="m-0 mb-2 font-mono text-sm">canWriteContent()</h4>
							<div class="mb-2">
								<span
									class={`px-2 py-1 rounded font-bold font-mono ${canWrite ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'}`}
								>
									{canWrite ? 'true' : 'false'}
								</span>
							</div>
							<p class="text-sm  mb-2">Checks if user can create new content</p>
							<code class="block bg-foreground/5 p-2 rounded font-mono text-xs border  mt-2">
								{canWrite
									? '// User can create content'
									: '// User cannot create content'}
							</code>
						</div>

						<div class="bg-foreground/10 p-4 rounded border">
							<h4 class="m-0 mb-2 font-mono text-sm">canEditContent()</h4>
							<div class="mb-2">
								<span
									class={`px-2 py-1 rounded font-bold font-mono ${canEdit ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'}`}
								>
									{canEdit ? 'true' : 'false'}
								</span>
							</div>
							<p class="text-sm  mb-2">
								Checks if user can edit existing content
							</p>
							<code class="block bg-foreground/5 p-2 rounded font-mono text-xs border  mt-2">
								{canEdit
									? '// User can edit content'
									: '// User cannot edit content'}
							</code>
						</div>

						<div class="bg-foreground/10 p-4 rounded border">
							<h4 class="m-0 mb-2 font-mono text-sm">canManageUser()</h4>
							<div class="mb-2">
								<span
									class={`px-2 py-1 rounded font-bold font-mono ${canManage ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'}`}
								>
									{canManage ? 'true' : 'false'}
								</span>
							</div>
							<p class="text-sm  mb-2">Checks if user can manage other users</p>
							<code class="block bg-foreground/5 p-2 rounded font-mono text-xs border  mt-2">
								{canManage
									? '// User can manage users'
									: '// User cannot manage users'}
							</code>
						</div>
					</div>
				</div>

				{/* ##################### */}
				{/* Role Checking Utilities */}
				<div class="bg-foreground/5 p-6 rounded border">
					<h3 class="text-lg font-semi m-0 mb-4 pb-2">
						Role Checking Utilities
					</h3>
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
						<div class="bg-foreground/10 p-4 rounded border ">
							<h4 class="m-0 mb-2 font-mono text-sm">isAdmin()</h4>
							<div class="mb-2">
								<span
									class={`px-2 py-1 rounded font-bold font-mono ${isUserAdmin ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'}`}
								>
									{isUserAdmin ? 'true' : 'false'}
								</span>
							</div>
							<p class="text-sm  mb-2">Checks if user has admin role</p>
							<code class="block bg-foreground/5 p-2 rounded font-mono text-xs border  mt-2">
								{isUserAdmin
									? '// User is an admin'
									: '// User is not an admin'}
							</code>
						</div>

						<div class="bg-foreground/10 p-4 rounded border ">
							<h4 class="m-0 mb-2 font-mono text-sm">hasRole('editor')</h4>
							<div class="mb-2">
								<span
									class={`px-2 py-1 rounded font-bold font-mono ${isUserEditor ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'}`}
								>
									{isUserEditor ? 'true' : 'false'}
								</span>
							</div>
							<p class="text-sm  mb-2">Checks if user has editor role</p>
							<code class="block bg-foreground/5 p-2 rounded font-mono text-xs border  mt-2">
								{isUserEditor
									? '// User is an editor'
									: '// User is not an editor'}
							</code>
						</div>

						<div class="bg-foreground/10 p-4 rounded border ">
							<h4 class="m-0 mb-2 font-mono text-sm">hasRole('viewer')</h4>
							<div class="mb-2">
								<span
									class={`px-2 py-1 rounded font-bold font-mono ${isUserViewer ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'}`}
								>
									{isUserViewer ? 'true' : 'false'}
								</span>
							</div>
							<p class="text-sm  mb-2">Checks if user has viewer role</p>
							<code class="block bg-foreground/5 p-2 rounded font-mono text-xs border  mt-2">
								{isUserViewer
									? '// User is a viewer'
									: '// User is not a viewer'}
							</code>
						</div>
					</div>
				</div>

				{/* Advanced Permission Utilities */}
				<div class="bg-foreground/5 p-6 rounded border">
					<h3 class="text-lg font-semi m-0 mb-4 pb-2">
						Advanced Permission Utilities
					</h3>
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
						<div class="bg-foreground/10 p-4 rounded border ">
							<h4 class="m-0 mb-2 font-mono text-sm">
								hasPermission('write_content')
							</h4>
							<div class="mb-2">
								<span
									class={`px-2 py-1 rounded font-bold font-mono ${hasWritePermission ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'}`}
								>
									{hasWritePermission ? 'true' : 'false'}
								</span>
							</div>
							<p class="text-sm ">
								Direct permission check for specific permission
							</p>
						</div>

						<div class="bg-foreground/10 p-4 rounded border ">
							<h4 class="m-0 mb-2 font-mono text-sm">
								hasAnyPermission(['write_content', 'edit_content'])
							</h4>
							<div class="mb-2">
								<span
									class={`px-2 py-1 rounded font-bold font-mono ${hasContentPermissions ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'}`}
								>
									{hasContentPermissions ? 'true' : 'false'}
								</span>
							</div>
							<p class="text-sm ">
								Checks if user has any of the specified permissions
							</p>
						</div>

						<div class="bg-foreground/10 p-4 rounded border ">
							<h4 class="m-0 mb-2 font-mono text-sm">getUserRole()</h4>
							<div class="mb-2">
								<span class="px-2 py-1 rounded font-bold font-mono bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200">
									'{userRole}'
								</span>
							</div>
							<p class="text-sm ">Returns the current user's role</p>
						</div>
					</div>
				</div>

				{/* Conditional Rendering Examples */}
				<div class="conditional-rendering-section">
					<h3 class="text-lg font-semibold mb-4">
						Conditional Rendering Examples
					</h3>
					<div>
						<div class="space-y-4">
							<h4 class="font-semibold py-4">Content Creation UI</h4>
							{canWrite ? (
								<div>
									<p>✅ Content creation tools are available</p>
									<Button variant="outline">Create New Article</Button>
									<Button variant="outline">Save Draft</Button>
								</div>
							) : (
								<div>
									<p>❌ Content creation requires write_content permission</p>
									{/* TODO: disable */}
									<Button variant="outline">Create New Article</Button>
								</div>
							)}
						</div>

						<div class="space-y-4">
							<h4 class="font-semibold py-4">Editorial Tools</h4>
							{canEdit ? (
								<div>
									<p>✅ Editorial tools are available</p>
									<Button variant="outline">Review Queue</Button>
									<Button variant="outline">Bulk Edit</Button>
									<Button variant="outline">Publish Content</Button>
								</div>
							) : (
								<div>
									<p>❌ Editorial tools require edit_content permission</p>
									<Button variant="outline">Review Queue</Button>
								</div>
							)}
						</div>

						<div class="space-y-4">
							<h4 class="font-semibold py-4">Admin Panel</h4>
							{canManage ? (
								<div class="feature-available">
									<p>✅ Administrative controls are available</p>
									{/* TODO: add color */}
									<Button variant="outline">Delete User</Button>
									<Button variant="outline">Change Roles</Button>
									<Button variant="outline">System Settings</Button>
								</div>
							) : (
								<div>
									<Button variant="outline">Admin Panel</Button>
									<p>❌ Admin panel requires manage_user permission</p>
								</div>
							)}
						</div>
					</div>
				</div>

				{/* Usage Code Examples */}
				<div class="conditional-rendering-section">
					<h3 class="text-lg font-semibold mb-4">Usage Code Examples</h3>
					<div class="space-y-6">
						<div class="code-example">
							<h4 class="font-bold py-4">Basic Permission Check</h4>
							<Code
								lang="astro"
								class="p-4"
								code={`
---
import { canWriteContent } from '@/lib/auth';

const canWrite = canWriteContent(Astro.locals);
---

{canWrite && (
  <button>Create Content</button>
)}
  `}
							/>
						</div>

						<div class="code-example">
							<h4 class="font-bold py-4">Role-Based Rendering</h4>
							<Code
								lang="astro"
								class="p-4"
								code={`
--- 
import {(isAdmin, hasRole)} from '@/lib/auth';

const isUserAdmin = isAdmin(Astro.locals);
const isEditor = hasRole(Astro.locals, 'editor');
---
{isUserAdmin && <AdminPanel />}
{isEditor && <EditorTools />}
`}
							/>
						</div>

						<div class="code-example">
							<h4 class="font-bold py-4">Multiple Permission Check</h4>
							<Code
								lang="astro"
								class="p-4"
								code={`
---
import { hasAnyPermission } from '@/lib/auth';

const hasContentAccess = hasAnyPermission(
  Astro.locals, 
  ['write_content', 'edit_content']
);
---

{hasContentAccess && <ContentManagement />
								`}
							/>
						</div>
					</div>
				</div>
			</div>
		)
	}
</div>
