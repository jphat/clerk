---
/**
 * Template Utility Demonstration Component
 *
 * Comprehensive showcase of all RBAC template utilities and their usage patterns.
 * Demonstrates conditional rendering, permission checking, and role-based UI adaptation.
 */

import {
	canWriteContent,
	canEditContent,
	canManageUser,
	hasRole,
	isAdmin,
	hasPermissionTemplate as hasPermission,
	hasAnyPermissionTemplate as hasAnyPermission,
	isAuthenticated,
	getUserRoleTemplate as getUserRole,
	getUserPermissionsTemplate as getUserPermissions,
} from '@/lib/auth';
import type { Permission } from '@/types/auth';

// Get all utility function results for demonstration
const authenticated = isAuthenticated(Astro.locals);
const userRole = getUserRole(Astro.locals);
const userPermissions = getUserPermissions(Astro.locals);

// Individual permission checks
const canWrite = canWriteContent(Astro.locals);
const canEdit = canEditContent(Astro.locals);
const canManage = canManageUser(Astro.locals);

// Role checks
const isUserAdmin = isAdmin(Astro.locals);
const isUserEditor = hasRole(Astro.locals, 'editor');
const isUserViewer = hasRole(Astro.locals, 'viewer');

// Advanced permission checks
const hasWritePermission = hasPermission(Astro.locals, 'write_content');
const hasEditPermission = hasPermission(Astro.locals, 'edit_content');
const hasManagePermission = hasPermission(Astro.locals, 'manage_user');

// Multiple permission checks
const hasContentPermissions = hasAnyPermission(Astro.locals, [
	'write_content',
	'edit_content',
]);
const hasAllPermissions = hasAnyPermission(Astro.locals, [
	'write_content',
	'edit_content',
	'manage_user',
]);

// Demo data for examples
const demoPermissions: Permission[] = [
	'write_content',
	'edit_content',
	'manage_user',
];
---

<div class="template-utility-demo">
	<div class="demo-header">
		<h2>Template Utility Functions Demonstration</h2>
		<p>
			Interactive showcase of all RBAC template utilities and their real-time
			results
		</p>
	</div>

	{
		!authenticated ? (
			<div class="auth-notice">
				<h3>⚠️ Authentication Required</h3>
				<p>
					Sign in to see the template utilities in action with real user data.
				</p>
				<a href="/sign-in" class="auth-button">
					Sign In to Test
				</a>
			</div>
		) : (
			<div class="demo-content">
				<div class="user-context-section">
					<h3>Current User Context</h3>
					<div class="context-grid">
						<div class="context-item">
							<strong>Authenticated:</strong>
							<span class={`status ${authenticated ? 'positive' : 'negative'}`}>
								{authenticated ? 'Yes' : 'No'}
							</span>
						</div>
						<div class="context-item">
							<strong>Role:</strong>
							<span class="role-badge role-{userRole}">{userRole}</span>
						</div>
						<div class="context-item">
							<strong>Permissions:</strong>
							<span class="permissions-list">
								{userPermissions.length > 0
									? userPermissions.join(', ')
									: 'None'}
							</span>
						</div>
					</div>
				</div>

				<div class="utilities-section">
					<h3>Permission Checking Utilities</h3>
					<div class="utility-grid">
						<div class="utility-card">
							<h4>canWriteContent()</h4>
							<div class="utility-result">
								<span class={`result ${canWrite ? 'true' : 'false'}`}>
									{canWrite ? 'true' : 'false'}
								</span>
							</div>
							<p class="utility-description">
								Checks if user can create new content
							</p>
							<code class="utility-code">
								{canWrite
									? '// User can create content'
									: '// User cannot create content'}
							</code>
						</div>

						<div class="utility-card">
							<h4>canEditContent()</h4>
							<div class="utility-result">
								<span class={`result ${canEdit ? 'true' : 'false'}`}>
									{canEdit ? 'true' : 'false'}
								</span>
							</div>
							<p class="utility-description">
								Checks if user can edit existing content
							</p>
							<code class="utility-code">
								{canEdit
									? '// User can edit content'
									: '// User cannot edit content'}
							</code>
						</div>

						<div class="utility-card">
							<h4>canManageUser()</h4>
							<div class="utility-result">
								<span class={`result ${canManage ? 'true' : 'false'}`}>
									{canManage ? 'true' : 'false'}
								</span>
							</div>
							<p class="utility-description">
								Checks if user can manage other users
							</p>
							<code class="utility-code">
								{canManage
									? '// User can manage users'
									: '// User cannot manage users'}
							</code>
						</div>
					</div>
				</div>

				<div class="utilities-section">
					<h3>Role Checking Utilities</h3>
					<div class="utility-grid">
						<div class="utility-card">
							<h4>isAdmin()</h4>
							<div class="utility-result">
								<span class={`result ${isUserAdmin ? 'true' : 'false'}`}>
									{isUserAdmin ? 'true' : 'false'}
								</span>
							</div>
							<p class="utility-description">Checks if user has admin role</p>
							<code class="utility-code">
								{isUserAdmin
									? '// User is an admin'
									: '// User is not an admin'}
							</code>
						</div>

						<div class="utility-card">
							<h4>hasRole('editor')</h4>
							<div class="utility-result">
								<span class={`result ${isUserEditor ? 'true' : 'false'}`}>
									{isUserEditor ? 'true' : 'false'}
								</span>
							</div>
							<p class="utility-description">Checks if user has editor role</p>
							<code class="utility-code">
								{isUserEditor
									? '// User is an editor'
									: '// User is not an editor'}
							</code>
						</div>

						<div class="utility-card">
							<h4>hasRole('viewer')</h4>
							<div class="utility-result">
								<span class={`result ${isUserViewer ? 'true' : 'false'}`}>
									{isUserViewer ? 'true' : 'false'}
								</span>
							</div>
							<p class="utility-description">Checks if user has viewer role</p>
							<code class="utility-code">
								{isUserViewer
									? '// User is a viewer'
									: '// User is not a viewer'}
							</code>
						</div>
					</div>
				</div>

				<div class="utilities-section">
					<h3>Advanced Permission Utilities</h3>
					<div class="utility-grid">
						<div class="utility-card">
							<h4>hasPermission('write_content')</h4>
							<div class="utility-result">
								<span class={`result ${hasWritePermission ? 'true' : 'false'}`}>
									{hasWritePermission ? 'true' : 'false'}
								</span>
							</div>
							<p class="utility-description">
								Direct permission check for specific permission
							</p>
						</div>

						<div class="utility-card">
							<h4>hasAnyPermission(['write_content', 'edit_content'])</h4>
							<div class="utility-result">
								<span
									class={`result ${hasContentPermissions ? 'true' : 'false'}`}
								>
									{hasContentPermissions ? 'true' : 'false'}
								</span>
							</div>
							<p class="utility-description">
								Checks if user has any of the specified permissions
							</p>
						</div>

						<div class="utility-card">
							<h4>getUserRole()</h4>
							<div class="utility-result">
								<span class="result role">'{userRole}'</span>
							</div>
							<p class="utility-description">Returns the current user's role</p>
						</div>
					</div>
				</div>

				<div class="conditional-rendering-section">
					<h3>Conditional Rendering Examples</h3>
					<div class="rendering-examples">
						<div class="example-card">
							<h4>Content Creation UI</h4>
							{canWrite ? (
								<div class="feature-available">
									<button type="button" class="demo-button primary">
										Create New Article
									</button>
									<button type="button" class="demo-button secondary">
										Save Draft
									</button>
									<p class="feature-note">
										✅ Content creation tools are available
									</p>
								</div>
							) : (
								<div class="feature-unavailable">
									<button type="button" class="demo-button disabled" disabled>
										Create New Article
									</button>
									<p class="feature-note">
										❌ Content creation requires write_content permission
									</p>
								</div>
							)}
						</div>

						<div class="example-card">
							<h4>Editorial Tools</h4>
							{canEdit ? (
								<div class="feature-available">
									<button type="button" class="demo-button primary">
										Review Queue
									</button>
									<button type="button" class="demo-button secondary">
										Bulk Edit
									</button>
									<button type="button" class="demo-button success">
										Publish Content
									</button>
									<p class="feature-note">✅ Editorial tools are available</p>
								</div>
							) : (
								<div class="feature-unavailable">
									<button type="button" class="demo-button disabled" disabled>
										Review Queue
									</button>
									<p class="feature-note">
										❌ Editorial tools require edit_content permission
									</p>
								</div>
							)}
						</div>

						<div class="example-card">
							<h4>Admin Panel</h4>
							{canManage ? (
								<div class="feature-available">
									<button type="button" class="demo-button danger">
										Delete User
									</button>
									<button type="button" class="demo-button warning">
										Change Roles
									</button>
									<button type="button" class="demo-button info">
										System Settings
									</button>
									<p class="feature-note">
										✅ Administrative controls are available
									</p>
								</div>
							) : (
								<div class="feature-unavailable">
									<button type="button" class="demo-button disabled" disabled>
										Admin Panel
									</button>
									<p class="feature-note">
										❌ Admin panel requires manage_user permission
									</p>
								</div>
							)}
						</div>
					</div>
				</div>

				<div class="code-examples-section">
					<h3>Usage Code Examples</h3>
					<div class="code-examples">
						<div class="code-example">
							<h4>Basic Permission Check</h4>
							<pre>
								<code>{`---
import { canWriteContent } from '@/lib/auth';

const canWrite = canWriteContent(Astro.locals);
---

{canWrite && (
  <button>Create Content</button>
)}`}</code>
							</pre>
						</div>

						<div class="code-example">
							<h4>Role-Based Rendering</h4>
							<pre>
								<code>{`---
import { isAdmin, hasRole } from '@/lib/auth';

const isUserAdmin = isAdmin(Astro.locals);
const isEditor = hasRole(Astro.locals, 'editor');
---

{isUserAdmin && <AdminPanel />}
{isEditor && <EditorTools />}`}</code>
							</pre>
						</div>

						<div class="code-example">
							<h4>Multiple Permission Check</h4>
							<pre>
								<code>{`---
import { hasAnyPermission } from '@/lib/auth';

const hasContentAccess = hasAnyPermission(
  Astro.locals, 
  ['write_content', 'edit_content']
);
---

{hasContentAccess && <ContentManagement />}`}</code>
							</pre>
						</div>
					</div>
				</div>
			</div>
		)
	}
</div>

<style>
	.template-utility-demo {
		max-width: 100%;
		font-family:
			-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
	}

	.demo-header {
		text-align: center;
		margin-bottom: 2rem;
		padding: 1.5rem;
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
		border-radius: 0.5rem;
	}

	.demo-header h2 {
		margin: 0 0 0.5rem 0;
		font-size: 1.5rem;
	}

	.demo-header p {
		margin: 0;
		opacity: 0.9;
	}

	.auth-notice {
		text-align: center;
		padding: 2rem;
		background: #fff3cd;
		border: 1px solid #ffeaa7;
		border-radius: 0.5rem;
		color: #856404;
	}

	.auth-button {
		display: inline-block;
		margin-top: 1rem;
		padding: 0.75rem 1.5rem;
		background: #007bff;
		color: white;
		text-decoration: none;
		border-radius: 0.25rem;
		font-weight: 500;
	}

	.auth-button:hover {
		background: #0056b3;
	}

	.demo-content {
		display: flex;
		flex-direction: column;
		gap: 2rem;
	}

	.user-context-section,
	.utilities-section,
	.conditional-rendering-section,
	.code-examples-section {
		background: #f8f9fa;
		padding: 1.5rem;
		border-radius: 0.5rem;
		border: 1px solid #dee2e6;
	}

	.user-context-section h3,
	.utilities-section h3,
	.conditional-rendering-section h3,
	.code-examples-section h3 {
		margin: 0 0 1rem 0;
		color: #495057;
		border-bottom: 2px solid #007bff;
		padding-bottom: 0.5rem;
	}

	.context-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 1rem;
	}

	.context-item {
		background: white;
		padding: 1rem;
		border-radius: 0.25rem;
		border: 1px solid #dee2e6;
	}

	.status.positive {
		color: #28a745;
		font-weight: bold;
	}

	.status.negative {
		color: #dc3545;
		font-weight: bold;
	}

	.role-badge {
		padding: 0.25rem 0.5rem;
		border-radius: 0.25rem;
		font-size: 0.8rem;
		font-weight: bold;
		text-transform: uppercase;
	}

	.role-admin {
		background: #dc3545;
		color: white;
	}

	.role-editor {
		background: #28a745;
		color: white;
	}

	.role-viewer {
		background: #6c757d;
		color: white;
	}

	.permissions-list {
		font-family: monospace;
		background: #e9ecef;
		padding: 0.25rem 0.5rem;
		border-radius: 0.25rem;
		font-size: 0.9rem;
	}

	.utility-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 1rem;
	}

	.utility-card {
		background: white;
		padding: 1rem;
		border-radius: 0.25rem;
		border: 1px solid #dee2e6;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}

	.utility-card h4 {
		margin: 0 0 0.5rem 0;
		color: #495057;
		font-family: monospace;
		font-size: 0.9rem;
	}

	.utility-result {
		margin-bottom: 0.5rem;
	}

	.result {
		padding: 0.25rem 0.5rem;
		border-radius: 0.25rem;
		font-weight: bold;
		font-family: monospace;
	}

	.result.true {
		background: #d4edda;
		color: #155724;
	}

	.result.false {
		background: #f8d7da;
		color: #721c24;
	}

	.result.role {
		background: #e2e3e5;
		color: #383d41;
	}

	.utility-description {
		margin: 0.5rem 0;
		font-size: 0.9rem;
		color: #666;
	}

	.utility-code {
		display: block;
		background: #f8f9fa;
		padding: 0.5rem;
		border-radius: 0.25rem;
		font-family: monospace;
		font-size: 0.8rem;
		color: #495057;
		border: 1px solid #e9ecef;
		margin-top: 0.5rem;
	}

	.rendering-examples {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 1rem;
	}

	.example-card {
		background: white;
		padding: 1rem;
		border-radius: 0.25rem;
		border: 1px solid #dee2e6;
	}

	.example-card h4 {
		margin: 0 0 1rem 0;
		color: #495057;
	}

	.feature-available,
	.feature-unavailable {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.demo-button {
		padding: 0.5rem 1rem;
		border: none;
		border-radius: 0.25rem;
		font-weight: 500;
		cursor: pointer;
		transition: background-color 0.2s ease;
	}

	.demo-button.primary {
		background: #007bff;
		color: white;
	}

	.demo-button.secondary {
		background: #6c757d;
		color: white;
	}

	.demo-button.success {
		background: #28a745;
		color: white;
	}

	.demo-button.danger {
		background: #dc3545;
		color: white;
	}

	.demo-button.warning {
		background: #ffc107;
		color: #212529;
	}

	.demo-button.info {
		background: #17a2b8;
		color: white;
	}

	.demo-button.disabled {
		background: #e9ecef;
		color: #6c757d;
		cursor: not-allowed;
	}

	.feature-note {
		margin: 0.5rem 0 0 0;
		font-size: 0.9rem;
		font-style: italic;
	}

	.code-examples {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 1rem;
	}

	.code-example {
		background: white;
		padding: 1rem;
		border-radius: 0.25rem;
		border: 1px solid #dee2e6;
	}

	.code-example h4 {
		margin: 0 0 0.5rem 0;
		color: #495057;
	}

	.code-example pre {
		margin: 0;
		background: #f8f9fa;
		padding: 1rem;
		border-radius: 0.25rem;
		overflow-x: auto;
		border: 1px solid #e9ecef;
	}

	.code-example code {
		font-family: 'Courier New', monospace;
		font-size: 0.8rem;
		color: #495057;
	}

	/* Responsive design */
	@media (max-width: 768px) {
		.context-grid,
		.utility-grid,
		.rendering-examples,
		.code-examples {
			grid-template-columns: 1fr;
		}

		.demo-header {
			padding: 1rem;
		}

		.demo-header h2 {
			font-size: 1.2rem;
		}
	}
</style>
