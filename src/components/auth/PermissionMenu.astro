---
/**
 * Permission-aware Menu Component
 *
 * This component renders navigation menus with permission-based filtering.
 * Menu items are only shown if the user has the required permissions.
 * Supports nested menu items with permission inheritance.
 */

import type { MenuItem } from '@/types/auth';
import {
	hasAnyPermissionTemplate as hasAnyPermission,
	isAuthenticated,
} from '@/lib/auth';

interface Props {
	items: MenuItem[];
	className?: string;
	nested?: boolean;
}

const { items, className = '', nested = false } = Astro.props;
const user = Astro.locals.user;

/**
 * Determine if a menu item should be shown based on user permissions
 *
 * @param item - Menu item to check
 * @returns True if the menu item should be displayed
 */
function shouldShowMenuItem(item: MenuItem): boolean {
	// If no permissions are specified, show to all authenticated users
	if (!item.permissions || item.permissions.length === 0) {
		return isAuthenticated(Astro.locals);
	}

	// If user is not authenticated, hide the item
	if (!user) {
		return false;
	}

	// Check if user has any of the required permissions
	return hasAnyPermission(Astro.locals, item.permissions);
}

/**
 * Filter menu items and their children based on permissions
 *
 * @param menuItems - Array of menu items to filter
 * @returns Filtered array of menu items
 */
function filterMenuItems(menuItems: MenuItem[]): MenuItem[] {
	return menuItems
		.filter(shouldShowMenuItem)
		.map((item) => {
			// If item has children, recursively filter them
			if (item.children && item.children.length > 0) {
				const filteredChildren = filterMenuItems(item.children);
				return {
					...item,
					children: filteredChildren,
				};
			}
			return item;
		})
		.filter((item) => {
			// Remove parent items that have no visible children
			if (item.children) {
				return item.children.length > 0 || shouldShowMenuItem(item);
			}
			return true;
		});
}

// Filter the menu items based on user permissions
const visibleItems = filterMenuItems(items);
---

{
	visibleItems.length > 0 && (
		<nav
			class={`block ${className} ${nested ? 'ml-4 border-l bg-foreground/20' : ''}`}
		>
			<ul class="list-none m-0 p-0">
				{visibleItems.map((item) => (
					<li class="relative">
						<a
							href={item.href}
							class={`block px-4 py-3 no-underline text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-inset transition-colors ${nested ? 'pl-6 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200' : ''}`}
							aria-label={item.label}
						>
							{item.label}
							{item.children && item.children.length > 0 && (
								<span class="float-right text-xs text-gray-400 dark:text-gray-500 transition-transform duration-200 hover:rotate-180">
									â–¼
								</span>
							)}
						</a>

						{item.children && item.children.length > 0 && (
							<Astro.self
								items={item.children}
								nested={true}
								className="submenu"
							/>
						)}
					</li>
				))}
			</ul>
		</nav>
	)
}
