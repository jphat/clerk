---
/**
 * Advanced Menu Example Component
 *
 * Demonstrates complex menu configurations with multiple permission scenarios,
 * nested structures, and conditional rendering patterns for the RBAC system.
 */

import PermissionMenu from './PermissionMenu.astro';
import type { MenuItem } from '@/types/auth';
import {
	isAuthenticated,
	getUserRoleTemplate as getUserRole,
	getUserPermissionsTemplate as getUserPermissions,
} from '@/lib/auth';

// Get current user context
const authenticated = isAuthenticated(Astro.locals);
const userRole = getUserRole(Astro.locals);
const userPermissions = getUserPermissions(Astro.locals);

// Complex menu configuration with various permission scenarios
const complexMenu: MenuItem[] = [
	{
		label: 'Dashboard',
		href: '/dashboard',
		// No permissions - visible to all authenticated users
	},
	{
		label: 'Content Hub',
		href: '/content',
		permissions: ['write_content', 'edit_content'], // Either permission works
		children: [
			{
				label: 'My Drafts',
				href: '/content/drafts',
				permissions: ['write_content'], // Writers can see their drafts
			},
			{
				label: 'Published Articles',
				href: '/content/published',
				permissions: ['write_content', 'edit_content'], // Writers and editors
			},
			{
				label: 'Editorial Review',
				href: '/content/review',
				permissions: ['edit_content'], // Editors only
				children: [
					{
						label: 'Pending Approval',
						href: '/content/review/pending',
						permissions: ['edit_content'],
					},
					{
						label: 'Revision Requests',
						href: '/content/review/revisions',
						permissions: ['edit_content'],
					},
				],
			},
			{
				label: 'Content Analytics',
				href: '/content/analytics',
				permissions: ['edit_content'], // Editors can see analytics
			},
		],
	},
	{
		label: 'Administration',
		href: '/admin',
		permissions: ['manage_user'], // Admin only section
		children: [
			{
				label: 'User Management',
				href: '/admin/users',
				permissions: ['manage_user'],
				children: [
					{
						label: 'Active Users',
						href: '/admin/users/active',
						permissions: ['manage_user'],
					},
					{
						label: 'Pending Registrations',
						href: '/admin/users/pending',
						permissions: ['manage_user'],
					},
					{
						label: 'Role Assignments',
						href: '/admin/users/roles',
						permissions: ['manage_user'],
					},
				],
			},
			{
				label: 'System Configuration',
				href: '/admin/config',
				permissions: ['manage_user'],
				children: [
					{
						label: 'General Settings',
						href: '/admin/config/general',
						permissions: ['manage_user'],
					},
					{
						label: 'Security Settings',
						href: '/admin/config/security',
						permissions: ['manage_user'],
					},
					{
						label: 'Integration Settings',
						href: '/admin/config/integrations',
						permissions: ['manage_user'],
					},
				],
			},
			{
				label: 'System Monitoring',
				href: '/admin/monitoring',
				permissions: ['manage_user'],
			},
		],
	},
	{
		label: 'Tools & Utilities',
		href: '/tools',
		// Mixed permissions - some tools for different roles
		children: [
			{
				label: 'Content Tools',
				href: '/tools/content',
				permissions: ['write_content', 'edit_content'],
				children: [
					{
						label: 'Bulk Editor',
						href: '/tools/content/bulk',
						permissions: ['edit_content'], // Editors only
					},
					{
						label: 'Template Generator',
						href: '/tools/content/templates',
						permissions: ['write_content'], // Writers can use templates
					},
					{
						label: 'SEO Analyzer',
						href: '/tools/content/seo',
						permissions: ['edit_content'], // Editors for SEO
					},
				],
			},
			{
				label: 'Reporting Tools',
				href: '/tools/reports',
				permissions: ['edit_content', 'manage_user'], // Editors and admins
				children: [
					{
						label: 'Content Reports',
						href: '/tools/reports/content',
						permissions: ['edit_content'],
					},
					{
						label: 'User Activity Reports',
						href: '/tools/reports/users',
						permissions: ['manage_user'], // Admin only
					},
					{
						label: 'System Reports',
						href: '/tools/reports/system',
						permissions: ['manage_user'], // Admin only
					},
				],
			},
		],
	},
	{
		label: 'Help & Support',
		href: '/help',
		// No permissions - available to all authenticated users
		children: [
			{
				label: 'User Guide',
				href: '/help/guide',
			},
			{
				label: 'FAQ',
				href: '/help/faq',
			},
			{
				label: 'Contact Support',
				href: '/help/contact',
			},
			{
				label: 'Feature Requests',
				href: '/help/features',
			},
		],
	},
];

// Simplified menu for demonstration
const roleBasedMenu: MenuItem[] = [
	{
		label: 'Public Area',
		href: '/public',
		// No permissions required
	},
	{
		label: 'Writer Zone',
		href: '/writer',
		permissions: ['write_content'],
	},
	{
		label: 'Editor Zone',
		href: '/editor',
		permissions: ['edit_content'],
	},
	{
		label: 'Admin Zone',
		href: '/admin',
		permissions: ['manage_user'],
	},
];
---

<div class="advanced-menu-example">
	<div class="example-section">
		<h3>Current User Context</h3>
		<div class="user-status">
			{
				authenticated ? (
					<div class="status-info">
						<p>
							<strong>Role:</strong> {userRole}
						</p>
						<p>
							<strong>Permissions:</strong>{' '}
							{userPermissions.length > 0 ? userPermissions.join(', ') : 'None'}
						</p>
					</div>
				) : (
					<p class="not-authenticated">
						Not authenticated - menus will show public items only
					</p>
				)
			}
		</div>
	</div>

	<div class="example-section">
		<h3>Complex Multi-Level Menu</h3>
		<p>This menu demonstrates nested permissions and complex hierarchies:</p>
		<div class="menu-container complex">
			<PermissionMenu items={complexMenu} className="complex-navigation" />
		</div>
	</div>

	<div class="example-section">
		<h3>Role-Based Simple Menu</h3>
		<p>This menu shows clear role-based access patterns:</p>
		<div class="menu-container simple">
			<PermissionMenu items={roleBasedMenu} className="role-navigation" />
		</div>
	</div>

	<div class="example-section">
		<h3>Permission Analysis</h3>
		<p>Here's how the menus are filtered based on your current permissions:</p>
		<div class="permission-analysis">
			<div class="analysis-grid">
				<div class="analysis-item">
					<h4>Total Menu Items</h4>
					<p class="metric">
						{
							complexMenu.length +
								complexMenu.flatMap((item) => item.children || []).length
						}
					</p>
				</div>
				<div class="analysis-item">
					<h4>Your Permissions</h4>
					<p class="metric">{userPermissions.length}</p>
				</div>
				<div class="analysis-item">
					<h4>Accessible Items</h4>
					<p class="metric">Varies by menu</p>
				</div>
			</div>
		</div>
	</div>

	<div class="example-section">
		<h3>Menu Behavior Examples</h3>
		<div class="behavior-examples">
			<div class="behavior-item">
				<h4>No Permissions Required</h4>
				<p>
					Items like "Dashboard" and "Help" are visible to all authenticated
					users
				</p>
				<code>// No permissions array specified</code>
			</div>
			<div class="behavior-item">
				<h4>Single Permission</h4>
				<p>
					Items requiring one specific permission (e.g., "manage_user" for
					admin)
				</p>
				<code>permissions: ['manage_user']</code>
			</div>
			<div class="behavior-item">
				<h4>Multiple Permissions (OR)</h4>
				<p>Items visible if user has ANY of the listed permissions</p>
				<code>permissions: ['write_content', 'edit_content']</code>
			</div>
			<div class="behavior-item">
				<h4>Nested Permission Inheritance</h4>
				<p>Child items can have different permissions than their parents</p>
				<code
					>// Parent and children can have different permission requirements</code
				>
			</div>
		</div>
	</div>
</div>

<style>
	.advanced-menu-example {
		max-width: 100%;
		font-family:
			-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
	}

	.example-section {
		margin-bottom: 2rem;
		padding: 1.5rem;
		border: 1px solid #e0e0e0;
		border-radius: 0.5rem;
		background-color: #fafafa;
	}

	.example-section h3 {
		margin-top: 0;
		margin-bottom: 1rem;
		color: #333;
		font-size: 1.2rem;
		border-bottom: 2px solid #007bff;
		padding-bottom: 0.5rem;
	}

	.user-status {
		background: white;
		padding: 1rem;
		border-radius: 0.25rem;
		border: 1px solid #ddd;
	}

	.status-info {
		color: #155724;
	}

	.not-authenticated {
		color: #721c24;
		font-style: italic;
		margin: 0;
	}

	.menu-container {
		background: white;
		border: 1px solid #ddd;
		border-radius: 0.25rem;
		padding: 0;
		margin-top: 1rem;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		overflow: hidden;
	}

	.menu-container.complex {
		max-height: 400px;
		overflow-y: auto;
	}

	.permission-analysis {
		background: white;
		padding: 1rem;
		border-radius: 0.25rem;
		border: 1px solid #ddd;
		margin-top: 1rem;
	}

	.analysis-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
		gap: 1rem;
	}

	.analysis-item {
		text-align: center;
		padding: 1rem;
		background: #f8f9fa;
		border-radius: 0.25rem;
		border: 1px solid #e9ecef;
	}

	.analysis-item h4 {
		margin: 0 0 0.5rem 0;
		color: #495057;
		font-size: 0.9rem;
	}

	.metric {
		font-size: 1.5rem;
		font-weight: bold;
		color: #007bff;
		margin: 0;
	}

	.behavior-examples {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 1rem;
		margin-top: 1rem;
	}

	.behavior-item {
		background: white;
		padding: 1rem;
		border-radius: 0.25rem;
		border: 1px solid #ddd;
	}

	.behavior-item h4 {
		margin: 0 0 0.5rem 0;
		color: #495057;
		font-size: 1rem;
	}

	.behavior-item p {
		margin: 0 0 0.5rem 0;
		font-size: 0.9rem;
		color: #666;
	}

	.behavior-item code {
		display: block;
		background: #f8f9fa;
		padding: 0.5rem;
		border-radius: 0.25rem;
		font-family: 'Courier New', monospace;
		font-size: 0.8rem;
		color: #495057;
		border: 1px solid #e9ecef;
	}

	/* Global menu styling */
	:global(.complex-navigation) {
		font-size: 0.9rem;
	}

	:global(.complex-navigation .menu-link) {
		padding: 0.5rem 1rem;
		border-bottom: 1px solid #f0f0f0;
	}

	:global(.role-navigation .menu-link) {
		padding: 0.75rem 1rem;
		font-weight: 500;
		border-bottom: 1px solid #f0f0f0;
	}

	:global(.role-navigation .menu-link:hover) {
		background-color: #e3f2fd;
	}

	/* Responsive design */
	@media (max-width: 768px) {
		.analysis-grid,
		.behavior-examples {
			grid-template-columns: 1fr;
		}

		.example-section {
			padding: 1rem;
		}

		.menu-container.complex {
			max-height: 300px;
		}
	}
</style>
