---
/**
 * Advanced Menu Example Component
 *
 * Demonstrates complex menu configurations with multiple permission scenarios,
 * nested structures, and conditional rendering patterns for the RBAC system.
 */

import PermissionMenu from './PermissionMenu.astro';
import type { MenuItem } from '@/types/auth';
import {
	isAuthenticated,
	getUserRoleTemplate as getUserRole,
	getUserPermissionsTemplate as getUserPermissions,
} from '@/lib/auth';

// Get current user context
const authenticated = isAuthenticated(Astro.locals);
const userRole = getUserRole(Astro.locals);
const userPermissions = getUserPermissions(Astro.locals);

// Complex menu configuration with various permission scenarios
const complexMenu: MenuItem[] = [
	{
		label: 'Dashboard',
		href: '/dashboard',
		// No permissions - visible to all authenticated users
	},
	{
		label: 'Content Hub',
		href: '/content',
		permissions: ['write_content', 'edit_content'], // Either permission works
		children: [
			{
				label: 'My Drafts',
				href: '/content/drafts',
				permissions: ['write_content'], // Writers can see their drafts
			},
			{
				label: 'Published Articles',
				href: '/content/published',
				permissions: ['write_content', 'edit_content'], // Writers and editors
			},
			{
				label: 'Editorial Review',
				href: '/content/review',
				permissions: ['edit_content'], // Editors only
				children: [
					{
						label: 'Pending Approval',
						href: '/content/review/pending',
						permissions: ['edit_content'],
					},
					{
						label: 'Revision Requests',
						href: '/content/review/revisions',
						permissions: ['edit_content'],
					},
				],
			},
			{
				label: 'Content Analytics',
				href: '/content/analytics',
				permissions: ['edit_content'], // Editors can see analytics
			},
		],
	},
	{
		label: 'Administration',
		href: '/a',
		permissions: ['manage_user'], // Admin only section
		children: [
			{
				label: 'User Management',
				href: '/a/users',
				permissions: ['manage_user'],
				children: [
					{
						label: 'Active Users',
						href: '/a/users/active',
						permissions: ['manage_user'],
					},
					{
						label: 'Pending Registrations',
						href: '/a/users/pending',
						permissions: ['manage_user'],
					},
					{
						label: 'Role Assignments',
						href: '/a/users/roles',
						permissions: ['manage_user'],
					},
				],
			},
			{
				label: 'System Configuration',
				href: '/a/config',
				permissions: ['manage_user'],
				children: [
					{
						label: 'General Settings',
						href: '/a/config/general',
						permissions: ['manage_user'],
					},
					{
						label: 'Security Settings',
						href: '/a/config/security',
						permissions: ['manage_user'],
					},
					{
						label: 'Integration Settings',
						href: '/a/config/integrations',
						permissions: ['manage_user'],
					},
				],
			},
			{
				label: 'System Monitoring',
				href: '/a/monitoring',
				permissions: ['manage_user'],
			},
		],
	},
	{
		label: 'Tools & Utilities',
		href: '/tools',
		// Mixed permissions - some tools for different roles
		children: [
			{
				label: 'Content Tools',
				href: '/tools/content',
				permissions: ['write_content', 'edit_content'],
				children: [
					{
						label: 'Bulk Editor',
						href: '/tools/content/bulk',
						permissions: ['edit_content'], // Editors only
					},
					{
						label: 'Template Generator',
						href: '/tools/content/templates',
						permissions: ['write_content'], // Writers can use templates
					},
					{
						label: 'SEO Analyzer',
						href: '/tools/content/seo',
						permissions: ['edit_content'], // Editors for SEO
					},
				],
			},
			{
				label: 'Reporting Tools',
				href: '/tools/reports',
				permissions: ['edit_content', 'manage_user'], // Editors and admins
				children: [
					{
						label: 'Content Reports',
						href: '/tools/reports/content',
						permissions: ['edit_content'],
					},
					{
						label: 'User Activity Reports',
						href: '/tools/reports/users',
						permissions: ['manage_user'], // Admin only
					},
					{
						label: 'System Reports',
						href: '/tools/reports/system',
						permissions: ['manage_user'], // Admin only
					},
				],
			},
		],
	},
	{
		label: 'Help & Support',
		href: '/help',
		// No permissions - available to all authenticated users
		children: [
			{
				label: 'User Guide',
				href: '/help/guide',
			},
			{
				label: 'FAQ',
				href: '/help/faq',
			},
			{
				label: 'Contact Support',
				href: '/help/contact',
			},
			{
				label: 'Feature Requests',
				href: '/help/features',
			},
		],
	},
];

// Simplified menu for demonstration
const roleBasedMenu: MenuItem[] = [
	{
		label: 'Public Area',
		href: '/public',
		// No permissions required
	},
	{
		label: 'Writer Zone',
		href: '/writer',
		permissions: ['write_content'],
	},
	{
		label: 'Editor Zone',
		href: '/editor',
		permissions: ['edit_content'],
	},
	{
		label: 'Admin Zone',
		href: '/a',
		permissions: ['manage_user'],
	},
];
---

<div class="w-full">
	<div class="mb-8 p-6 border rounded-lg bg-foreground/5">
		<h3
			class="mt-0 mb-4 text-xl font-semibold text-gray-800 dark:text-gray-200 border-b-2 border-blue-500 dark:border-blue-400 pb-2"
		>
			Current User Context
		</h3>
		<div class="bg-foreground/10 p-4 rounded border">
			{
				authenticated ? (
					<div class="text-green-800 dark:text-green-200">
						<p class="mb-2">
							<strong>Role:</strong> {userRole}
						</p>
						<p class="mb-0">
							<strong>Permissions:</strong>{' '}
							{userPermissions.length > 0 ? userPermissions.join(', ') : 'None'}
						</p>
					</div>
				) : (
					<p class="text-red-800 dark:text-red-200 italic m-0">
						Not authenticated - menus will show public items only
					</p>
				)
			}
		</div>
	</div>

	<div class="mb-8 p-6 border rounded-lg bg-foreground/5">
		<h3
			class="mt-0 mb-4 text-xl font-semibold text-gray-800 dark:text-gray-200 border-b-2 border-blue-500 dark:border-blue-400 pb-2"
		>
			Complex Multi-Level Menu
		</h3>
		<p class="mb-4 text-gray-700 dark:text-gray-300">
			This menu demonstrates nested permissions and complex hierarchies:
		</p>
		<div
			class="bg-foreground/10 border rounded p-0 mt-4 shadow-sm max-h-96 overflow-y-auto"
		>
			<PermissionMenu items={complexMenu} className="complex-navigation" />
		</div>
	</div>

	<div class="mb-8 p-6 border rounded-lg bg-foreground/5">
		<h3
			class="mt-0 mb-4 text-xl font-semibold text-gray-800 dark:text-gray-200 border-b-2 border-blue-500 dark:border-blue-400 pb-2"
		>
			Role-Based Simple Menu
		</h3>
		<p class="mb-4 text-gray-700 dark:text-gray-300">
			This menu shows clear role-based access patterns:
		</p>
		<div
			class="bg-foreground/10 border rounded p-0 mt-4 shadow-sm overflow-hidden"
		>
			<PermissionMenu items={roleBasedMenu} className="role-navigation" />
		</div>
	</div>

	<div class="mb-8 p-6 border rounded-lg bg-foreground/5">
		<h3
			class="mt-0 mb-4 text-xl font-semibold text-gray-800 dark:text-gray-200 border-b-2 border-blue-500 dark:border-blue-400 pb-2"
		>
			Permission Analysis
		</h3>
		<p class="mb-4 text-gray-700 dark:text-gray-300">
			Here's how the menus are filtered based on your current permissions:
		</p>
		<div class="bg-foreground/10 p-4 rounded border mt-4">
			<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
				<div
					class="text-center p-4 bg-foreground/15 rounded border border-gray-200 dark:border-gray-500"
				>
					<h4 class="m-0 mb-2 text-gray-700 dark:text-gray-300 text-sm">
						Total Menu Items
					</h4>
					<p class="text-2xl font-bold text-blue-500 dark:text-blue-400 m-0">
						{
							complexMenu.length +
								complexMenu.flatMap((item) => item.children || []).length
						}
					</p>
				</div>
				<div
					class="text-center p-4 bg-foreground/15 rounded border border-gray-200 dark:border-gray-500"
				>
					<h4 class="m-0 mb-2 text-gray-700 dark:text-gray-300 text-sm">
						Your Permissions
					</h4>
					<p class="text-2xl font-bold text-blue-500 dark:text-blue-400 m-0">
						{userPermissions.length}
					</p>
				</div>
				<div
					class="text-center p-4 bg-foreground/15 rounded border border-gray-200 dark:border-gray-500"
				>
					<h4 class="m-0 mb-2 text-gray-700 dark:text-gray-300 text-sm">
						Accessible Items
					</h4>
					<p class="text-2xl font-bold text-blue-500 dark:text-blue-400 m-0">
						Varies by menu
					</p>
				</div>
			</div>
		</div>
	</div>

	<p>
		:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
	</p>

	<div class="mb-8 p-6 border rounded-lg bg-foreground/5">
		<h3
			class="mt-0 mb-4 text-xl font-semibold text-gray-800 dark:text-gray-200 border-b-2 border-blue-500 dark:border-blue-400 pb-2"
		>
			Menu Behavior Examples
		</h3>
		<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
			<div class="bg-foreground/10 p-4 rounded border">
				<h4 class="m-0 mb-2 text-gray-700 dark:text-gray-300 text-base">
					No Permissions Required
				</h4>
				<p class="m-0 mb-2 text-sm text-gray-600 dark:text-gray-400">
					Items like "Dashboard" and "Help" are visible to all authenticated
					users
				</p>
				<code
					class="block bg-foreground/15 p-2 rounded font-mono text-xs text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-500"
					>// No permissions array specified</code
				>
			</div>
			<div class="bg-foreground/10 p-4 rounded border">
				<h4 class="m-0 mb-2 text-gray-700 dark:text-gray-300 text-base">
					Single Permission
				</h4>
				<p class="m-0 mb-2 text-sm text-gray-600 dark:text-gray-400">
					Items requiring one specific permission (e.g., "manage_user" for
					admin)
				</p>
				<code
					class="block bg-foreground/15 p-2 rounded font-mono text-xs text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-500"
					>permissions: ['manage_user']</code
				>
			</div>
			<div class="bg-foreground/10 p-4 rounded border">
				<h4 class="m-0 mb-2 text-gray-700 dark:text-gray-300 text-base">
					Multiple Permissions (OR)
				</h4>
				<p class="m-0 mb-2 text-sm text-gray-600 dark:text-gray-400">
					Items visible if user has ANY of the listed permissions
				</p>
				<code
					class="block bg-foreground/15 p-2 rounded font-mono text-xs text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-500"
					>permissions: ['write_content', 'edit_content']</code
				>
			</div>
			<div class="bg-foreground/10 p-4 rounded border">
				<h4 class="m-0 mb-2 text-gray-700 dark:text-gray-300 text-base">
					Nested Permission Inheritance
				</h4>
				<p class="m-0 mb-2 text-sm text-gray-600 dark:text-gray-400">
					Child items can have different permissions than their parents
				</p>
				<code
					class="block bg-foreground/15 p-2 rounded font-mono text-xs text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-500"
					>// Parent and children can have different permission requirements</code
				>
			</div>
		</div>
	</div>
</div>
