---
/**
 * Editor Test Page
 *
 * Demonstrates editor-level functionality with content creation and editing permissions.
 * This page showcases RBAC features for users with editor role.
 */

import Layout from '@/layouts/Layout.astro';
import PermissionExample from '@/components/auth/PermissionExample.astro';
import MenuExample from '@/components/auth/MenuExample.astro';
import PermissionMenu from '@/components/auth/PermissionMenu.astro';
import {
	canWriteContent,
	canEditContent,
	canManageUser,
	hasRole,
	isAuthenticated,
	getUserRoleTemplate as getUserRole,
	getUserPermissionsTemplate as getUserPermissions,
} from '@/lib/auth';
import type { MenuItem, PageMeta } from '@/types';

// Page metadata
const pageMeta: PageMeta = {
	title: 'Editor Test Page - RBAC Demo',
	description:
		'Demonstration of editor-level access and content permissions in the RBAC system',
	language: 'en',
};

// Get user context
const userRole = getUserRole(Astro.locals);
const userPermissions = getUserPermissions(Astro.locals);
const authenticated = isAuthenticated(Astro.locals);
const editorAccess =
	hasRole(Astro.locals, 'editor') || hasRole(Astro.locals, 'admin');
const hasContentPermissions =
	canWriteContent(Astro.locals) || canEditContent(Astro.locals);

// Editor-specific menu configuration
const editorMenu: MenuItem[] = [
	{
		label: 'Content Dashboard',
		href: '/editor/dashboard',
		permissions: ['write_content', 'edit_content'],
	},
	{
		label: 'My Content',
		href: '/editor/my-content',
		permissions: ['write_content'],
		children: [
			{
				label: 'Drafts',
				href: '/editor/my-content/drafts',
				permissions: ['write_content'],
			},
			{
				label: 'Published',
				href: '/editor/my-content/published',
				permissions: ['write_content'],
			},
			{
				label: 'Archived',
				href: '/editor/my-content/archived',
				permissions: ['write_content'],
			},
		],
	},
	{
		label: 'Content Management',
		href: '/editor/content',
		permissions: ['edit_content'],
		children: [
			{
				label: 'Review Queue',
				href: '/editor/content/review',
				permissions: ['edit_content'],
			},
			{
				label: 'Edit Articles',
				href: '/editor/content/edit',
				permissions: ['edit_content'],
			},
			{
				label: 'Content Library',
				href: '/editor/content/library',
				permissions: ['edit_content'],
			},
		],
	},
	{
		label: 'Publishing Tools',
		href: '/editor/tools',
		permissions: ['edit_content'],
		children: [
			{
				label: 'Bulk Editor',
				href: '/editor/tools/bulk',
				permissions: ['edit_content'],
			},
			{
				label: 'SEO Tools',
				href: '/editor/tools/seo',
				permissions: ['edit_content'],
			},
			{
				label: 'Analytics',
				href: '/editor/tools/analytics',
				permissions: ['edit_content'],
			},
		],
	},
];
---

<Layout pageMeta={pageMeta}>
	<div class="container">
		<header class="text-center mb-12 text-white">
			<h1 class="text-5xl font-bold mb-2 drop-shadow-lg">Editor Test Page</h1>
			<p class="text-xl opacity-90 m-0">
				Demonstrating editor-level access and content management capabilities
			</p>
		</header>

		{
			!authenticated ? (
				<div class="bg-white dark:bg-gray-800 p-8 rounded-2xl text-center shadow-2xl">
					<h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-gray-100">
						Authentication Required
					</h2>
					<p class="mb-6 text-gray-700 dark:text-gray-300">
						Please sign in to access this editor test page.
					</p>
					<a
						href="/sign-in"
						class="inline-block px-6 py-3 bg-blue-500 dark:bg-blue-600 text-white  font-medium hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors no-underline"
					>
						Sign In
					</a>
				</div>
			) : !hasContentPermissions ? (
				<div class="bg-white dark:bg-gray-800 p-8 rounded-2xl text-center shadow-2xl">
					<h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-gray-100">
						Content Permissions Required
					</h2>
					<p class="mb-4 text-gray-700 dark:text-gray-300">
						Your current role ({userRole}) does not have content creation or
						editing permissions. This page requires editor-level access.
					</p>
					<p class="mb-4 text-gray-700 dark:text-gray-300">
						<strong>Your permissions:</strong>{' '}
						{userPermissions.length > 0 ? userPermissions.join(', ') : 'None'}
					</p>
					<div class="bg-gray-50 dark:bg-gray-700 p-4  my-4 border-l-4 border-cyan-500">
						<p class="mb-2 text-gray-700 dark:text-gray-300">
							<strong>Required permissions:</strong> write_content or
							edit_content
						</p>
						<p class="mb-0 text-gray-700 dark:text-gray-300">
							<strong>Available roles with these permissions:</strong> editor,
							admin
						</p>
					</div>
					<a
						href="/test/menu"
						class="inline-block px-6 py-3 bg-gray-500 dark:bg-gray-600 text-white  font-medium hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors no-underline"
					>
						Back to Menu Test
					</a>
				</div>
			) : (
				<div class="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-2xl">
					<div class="bg-gray-50 dark:bg-gray-700 p-6  mb-8 border-l-4 border-green-500">
						<h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">
							Current User Information
						</h2>
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
							<div class="p-3 bg-white dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500">
								<strong class="text-gray-900 dark:text-gray-100">Role:</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">{userRole}</span>
							</div>
							<div class="p-3 bg-white dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500">
								<strong class="text-gray-900 dark:text-gray-100">
									Permissions:
								</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">
									{userPermissions.join(', ')}
								</span>
							</div>
							<div class="p-3 bg-white dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500">
								<strong class="text-gray-900 dark:text-gray-100">
									Can Write:
								</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">
									{canWriteContent(Astro.locals) ? 'Yes' : 'No'}
								</span>
							</div>
							<div class="p-3 bg-white dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500">
								<strong class="text-gray-900 dark:text-gray-100">
									Can Edit:
								</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">
									{canEditContent(Astro.locals) ? 'Yes' : 'No'}
								</span>
							</div>
						</div>
					</div>

					<div class="demo-section">
						<h2>Editor Menu Navigation</h2>
						<p>
							This menu shows editor-specific navigation options for content
							management:
						</p>
						<div class="menu-demo">
							<PermissionMenu
								items={editorMenu}
								className="editor-navigation"
							/>
						</div>
					</div>

					<div class="demo-section">
						<h2>Content Management Actions</h2>
						<p>
							These actions are available based on your content permissions:
						</p>
						<div class="content-actions">
							{canWriteContent(Astro.locals) && (
								<div class="action-group">
									<h3>Writing Permissions</h3>
									<button type="button" class="btn btn-success">
										Create New Article
									</button>
									<button type="button" class="btn btn-info">
										Save Draft
									</button>
									<button type="button" class="btn btn-warning">
										Submit for Review
									</button>
								</div>
							)}

							{canEditContent(Astro.locals) && (
								<div class="action-group">
									<h3>Editing Permissions</h3>
									<button type="button" class="btn btn-primary">
										Edit Published Content
									</button>
									<button type="button" class="btn btn-info">
										Review Submissions
									</button>
									<button type="button" class="btn btn-success">
										Approve for Publishing
									</button>
								</div>
							)}

							{!canManageUser(Astro.locals) && (
								<div class="action-group disabled">
									<h3>Admin-Only Actions (Not Available)</h3>
									<button type="button" class="btn btn-disabled" disabled>
										Manage Users
									</button>
									<button type="button" class="btn btn-disabled" disabled>
										System Settings
									</button>
									<button type="button" class="btn btn-disabled" disabled>
										Delete Any Content
									</button>
								</div>
							)}
						</div>
					</div>

					<div class="demo-section">
						<h2>Permission-Based Components</h2>
						<p>The following component demonstrates conditional rendering:</p>
						<PermissionExample />
					</div>

					<div class="demo-section">
						<h2>Content Workflow Simulation</h2>
						<p>
							This simulates a typical content creation and editing workflow:
						</p>
						<div class="workflow">
							<div class="workflow-step">
								<div class="step-number">1</div>
								<div class="step-content">
									<h4>Create Content</h4>
									<p>
										{canWriteContent(Astro.locals)
											? '✅ You can create new content'
											: '❌ Write permission required'}
									</p>
								</div>
							</div>
							<div class="workflow-step">
								<div class="step-number">2</div>
								<div class="step-content">
									<h4>Edit & Review</h4>
									<p>
										{canEditContent(Astro.locals)
											? '✅ You can edit and review content'
											: '❌ Edit permission required'}
									</p>
								</div>
							</div>
							<div class="workflow-step">
								<div class="step-number">3</div>
								<div class="step-content">
									<h4>Publish</h4>
									<p>
										{canEditContent(Astro.locals)
											? '✅ You can publish content'
											: '❌ Edit permission required'}
									</p>
								</div>
							</div>
						</div>
					</div>

					<div class="demo-section">
						<h2>Standard Menu Example</h2>
						<p>This shows how the standard menu appears for editor users:</p>
						<MenuExample />
					</div>

					<div class="demo-section">
						<h2>Test Other Roles</h2>
						<p>Compare editor access with other role levels:</p>
						<div class="role-links">
							<a href="/test/a" class="btn btn-outline">
								Admin Test Page
							</a>
							<a href="/test/viewer" class="btn btn-outline">
								Viewer Test Page
							</a>
							<a href="/test/menu" class="btn btn-outline">
								Menu Test Page
							</a>
						</div>
					</div>
				</div>
			)
		}
	</div>
</Layout>
