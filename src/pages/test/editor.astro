---
/**
 * Editor Test Page
 *
 * Demonstrates editor-level functionality with content creation and editing permissions.
 * This page showcases RBAC features for users with editor role.
 */

import { Check, X } from 'lucide-vue-next';
import TitleBar from '@/components/site/TitleBar.astro';
import { Button } from '@/components/ui/button';
import Layout from '@/layouts/Layout.astro';
import PermissionExample from '@/components/auth/PermissionExample.astro';
import MenuExample from '@/components/auth/MenuExample.astro';
import PermissionMenu from '@/components/auth/PermissionMenu.astro';
import {
	canWriteContent,
	canEditContent,
	canManageUser,
	// hasRole,
	isAuthenticated,
	getUserRoleTemplate as getUserRole,
	getUserPermissionsTemplate as getUserPermissions,
} from '@/lib/auth';
import type { MenuItem, PageMeta } from '@/types';

// Page metadata
const pageMeta: PageMeta = {
	title: 'Editor Test Page - RBAC Demo',
	description:
		'Demonstration of editor-level access and content permissions in the RBAC system',
	language: 'en',
};

// Get user context
const userRole = getUserRole(Astro.locals);
const userPermissions = getUserPermissions(Astro.locals);
const authenticated = isAuthenticated(Astro.locals);
// const editorAccess = hasRole(Astro.locals, 'editor') || hasRole(Astro.locals, 'admin');
const hasContentPermissions =
	canWriteContent(Astro.locals) || canEditContent(Astro.locals);

// Editor-specific menu configuration
const editorMenu: MenuItem[] = [
	{
		label: 'Content Dashboard',
		href: '/editor/dashboard',
		permissions: ['write_content', 'edit_content'],
	},
	{
		label: 'My Content',
		href: '/editor/my-content',
		permissions: ['write_content'],
		children: [
			{
				label: 'Drafts',
				href: '/editor/my-content/drafts',
				permissions: ['write_content'],
			},
			{
				label: 'Published',
				href: '/editor/my-content/published',
				permissions: ['write_content'],
			},
			{
				label: 'Archived',
				href: '/editor/my-content/archived',
				permissions: ['write_content'],
			},
		],
	},
	{
		label: 'Content Management',
		href: '/editor/content',
		permissions: ['edit_content'],
		children: [
			{
				label: 'Review Queue',
				href: '/editor/content/review',
				permissions: ['edit_content'],
			},
			{
				label: 'Edit Articles',
				href: '/editor/content/edit',
				permissions: ['edit_content'],
			},
			{
				label: 'Content Library',
				href: '/editor/content/library',
				permissions: ['edit_content'],
			},
		],
	},
	{
		label: 'Publishing Tools',
		href: '/editor/tools',
		permissions: ['edit_content'],
		children: [
			{
				label: 'Bulk Editor',
				href: '/editor/tools/bulk',
				permissions: ['edit_content'],
			},
			{
				label: 'SEO Tools',
				href: '/editor/tools/seo',
				permissions: ['edit_content'],
			},
			{
				label: 'Analytics',
				href: '/editor/tools/analytics',
				permissions: ['edit_content'],
			},
		],
	},
];
---

<Layout pageMeta={pageMeta}>
	<TitleBar
		breadcrumbs={[
			{ title: 'Home', url: '/' },
			{ title: 'Test', url: '/test' },
			{ title: pageMeta.title, url: '' },
		]}
		description={pageMeta.description}
		title={pageMeta.title}
	/>

	<div class="container">
		{
			!authenticated ? (
				<>
					<h2 class="text-2xl font-semibold mb-4">Authentication Required</h2>
					<p class="mb-6">Please sign in to access this editor test page.</p>
					<Button variant="default">
						<a href="/sign-in"> Sign In </a>
					</Button>
				</>
			) : !hasContentPermissions ? (
				<>
					<h2 class="text-2xl font-semibold mb-4">
						Content Permissions Required
					</h2>
					<p class="mb-4">
						Your current role ({userRole}) does not have content creation or
						editing permissions. This page requires editor-level access.
					</p>
					<p class="mb-4">
						<strong>Your permissions:</strong>{' '}
						{userPermissions.length > 0 ? userPermissions.join(', ') : 'None'}
					</p>
					<div class="bg-foreground/5 p-4 my-4 space-y-4">
						<p>
							<strong>Required permissions:</strong> write_content or
							edit_content
						</p>
						<p>
							<strong>Available roles with these permissions:</strong> editor,
							admin
						</p>
					</div>
					<Button variant="default">
						<a href="/test/menu"> Back to Menu Test </a>
					</Button>
				</>
			) : (
				<>
					{/* Current User Information */}
					{/* TODO: componentize */}
					<div class="border mb-10 p-6">
						<h2 class="text-2xl font-semibold mb-4">
							Current User Information
						</h2>
						<p> Quick overview of current user's role and permissions </p>
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
							<div class="p-3  rounded border bg-foreground/5 ">
								<strong>Role:</strong> <span>{userRole}</span>
							</div>
							<div class="p-3  rounded border bg-foreground/5 ">
								<strong>Permissions:</strong> {/* TODO: componentize */}
								<span class="text-sm gap-2">
									{userPermissions.length > 0
										? userPermissions.map((permission) => (
												<code class="rounded font-mono bg-foreground/10 px-1 mx-1 inline-block">
													{permission}
												</code>
											))
										: 'None'}
								</span>
							</div>
							<div class="p-3  rounded border bg-foreground/5 ">
								<strong>Can Write:</strong>{' '}
								<span>{canWriteContent(Astro.locals) ? 'Yes' : 'No'}</span>
							</div>
							<div class="p-3  rounded border bg-foreground/5 ">
								<strong>Can Edit:</strong>{' '}
								<span>{canEditContent(Astro.locals) ? 'Yes' : 'No'}</span>
							</div>
						</div>
					</div>

					{/* Editor Menu Navigation */}
					<div class="border mb-10 p-6">
						<h2 class="text-2xl font-semibold mb-4">Editor Menu Navigation</h2>
						<p class=" mb-6">
							This menu shows editor-specific navigation options for content
							management:
						</p>
						<PermissionMenu items={editorMenu} className="editor-navigation" />
					</div>

					{/* Content Management Actions */}
					<div class="border mb-10 p-6 space-y-4">
						<h2 class="text-2xl font-semibold mb-4">
							Content Management Actions
						</h2>
						<p>
							These actions are available based on your content permissions:
						</p>
						<div class=" space-y-4">
							{canWriteContent(Astro.locals) && (
								<>
									<h3 class="text-lg font-semibold">Writing Permissions</h3>
									<Button variant="outline">Create New Article</Button>
									<Button variant="outline">Save Draft</Button>
									<Button variant="outline">Submit for Review</Button>
								</>
							)}

							{canEditContent(Astro.locals) && (
								<>
									<h3 class="text-lg font-semibold">Editing Permissions</h3>
									<Button variant="outline">Edit Published Content</Button>
									<Button variant="outline">Review Submissions</Button>
									<Button variant="outline">Approve for Publishing</Button>
								</>
							)}

							{!canManageUser(Astro.locals) && (
								<>
									{/* TODO: determine how this is renderable */}
									<h3 class="text-lg font-semibold">
										Admin-Only Actions (Not Available)
									</h3>
									<Button variant="outline">Manage Users</Button>
									<Button variant="outline">System Settings</Button>
									<Button variant="outline">Delete Any Content</Button>
								</>
							)}
						</div>
					</div>

					{/* Permission-Based Components */}
					<div class="border mb-10 p-6 space-y-4">
						<h2 class="text-2xl font-semibold mb-4">
							Permission-Based Components
						</h2>
						<p>The following component demonstrates conditional rendering:</p>
						<PermissionExample />
					</div>

					{/* Content Workflow Simulation */}
					{/* TODO: not needed */}
					<div class="border mb-10 p-6 space-y-4">
						<h2 class="text-2xl font-semibold mb-4">
							Content Workflow Simulation
						</h2>
						<p>
							This simulates a typical content creation and editing workflow:
						</p>
						<div>
							<ol class="list-decimal ml-8 space-y-4">
								<li class="space-y-2">
									<h4 class="font-semibold">Create Content</h4>
									{/* <p> */}
									{canWriteContent(Astro.locals) ? (
										<p class="flex  gap-2">
											<Check class="stroke-green-600" /> You can create new
											content
										</p>
									) : (
										<p class="flex  gap-2">
											<X class="stroke-destructive" /> Write permission
											required'
										</p>
									)}
									{/* </p> */}
								</li>
								<li class="space-y-2">
									<h4 class="font-semibold">Edit & Review</h4>
									{/* <p> */}
									{canEditContent(Astro.locals) ? (
										<p class="flex  gap-2">
											<Check class="stroke-green-600" />
											You can edit and review content'
										</p>
									) : (
										<p class="flex  gap-2">
											<X class="stroke-destructive" /> Edit permission required'
										</p>
									)}
									{/* </p> */}
								</li>
								<li class="space-y-2">
									<h4 class="font-semibold">Publish</h4>
									{canEditContent(Astro.locals) ? (
										<p class="flex  gap-2">
											<Check class="stroke-green-600" /> You can publish
											content'
										</p>
									) : (
										<p class="flex  gap-2">
											<X class="stroke-destructive" /> Edit permission required'
										</p>
									)}
								</li>
							</ol>
						</div>
					</div>

					{/* Standard Menu Example */}
					<div class="border mb-10 p-6 space-y-4">
						<h2 class="text-2xl font-semibold mb-4">Standard Menu Example</h2>
						<p>This shows how the standard menu appears for editor users:</p>
						<MenuExample />
					</div>

					{/* Test Other Roles */}
					<div class="border mb-10 p-6 space-y-4">
						<h2 class="text-2xl font-semibold mb-4">Test Other Roles</h2>
						<p>Compare editor access with other role levels:</p>
						<div class="role-links">
							<Button variant="outline">
								<a href="/test/admin">Admin Test Page</a>
							</Button>
							<Button variant="outline">
								<a href="/test/viewer">Viewer Test Page</a>
							</Button>
							<Button variant="outline">
								<a href="/test/menu">Menu Test Page</a>
							</Button>
						</div>
					</div>
				</>
			)
		}
	</div>
</Layout>
