---
/**
 * Editor Test Page
 *
 * Demonstrates editor-level functionality with content creation and editing permissions.
 * This page showcases RBAC features for users with editor role.
 */

import Layout from '@/layouts/Layout.astro';
import PermissionExample from '@/components/auth/PermissionExample.astro';
import MenuExample from '@/components/auth/MenuExample.astro';
import PermissionMenu from '@/components/auth/PermissionMenu.astro';
import {
	canWriteContent,
	canEditContent,
	canManageUser,
	hasRole,
	isAuthenticated,
	getUserRoleTemplate as getUserRole,
	getUserPermissionsTemplate as getUserPermissions,
} from '@/lib/auth';
import type { MenuItem, PageMeta } from '@/types';

// Page metadata
const pageMeta: PageMeta = {
	title: 'Editor Test Page - RBAC Demo',
	description:
		'Demonstration of editor-level access and content permissions in the RBAC system',
	language: 'en',
};

// Get user context
const userRole = getUserRole(Astro.locals);
const userPermissions = getUserPermissions(Astro.locals);
const authenticated = isAuthenticated(Astro.locals);
const editorAccess =
	hasRole(Astro.locals, 'editor') || hasRole(Astro.locals, 'admin');
const hasContentPermissions =
	canWriteContent(Astro.locals) || canEditContent(Astro.locals);

// Editor-specific menu configuration
const editorMenu: MenuItem[] = [
	{
		label: 'Content Dashboard',
		href: '/editor/dashboard',
		permissions: ['write_content', 'edit_content'],
	},
	{
		label: 'My Content',
		href: '/editor/my-content',
		permissions: ['write_content'],
		children: [
			{
				label: 'Drafts',
				href: '/editor/my-content/drafts',
				permissions: ['write_content'],
			},
			{
				label: 'Published',
				href: '/editor/my-content/published',
				permissions: ['write_content'],
			},
			{
				label: 'Archived',
				href: '/editor/my-content/archived',
				permissions: ['write_content'],
			},
		],
	},
	{
		label: 'Content Management',
		href: '/editor/content',
		permissions: ['edit_content'],
		children: [
			{
				label: 'Review Queue',
				href: '/editor/content/review',
				permissions: ['edit_content'],
			},
			{
				label: 'Edit Articles',
				href: '/editor/content/edit',
				permissions: ['edit_content'],
			},
			{
				label: 'Content Library',
				href: '/editor/content/library',
				permissions: ['edit_content'],
			},
		],
	},
	{
		label: 'Publishing Tools',
		href: '/editor/tools',
		permissions: ['edit_content'],
		children: [
			{
				label: 'Bulk Editor',
				href: '/editor/tools/bulk',
				permissions: ['edit_content'],
			},
			{
				label: 'SEO Tools',
				href: '/editor/tools/seo',
				permissions: ['edit_content'],
			},
			{
				label: 'Analytics',
				href: '/editor/tools/analytics',
				permissions: ['edit_content'],
			},
		],
	},
];
---

<Layout pageMeta={pageMeta}>
	<div class="editor-test-page">
		<div class="container">
			<header class="page-header">
				<h1>Editor Test Page</h1>
				<p class="subtitle">
					Demonstrating editor-level access and content management capabilities
				</p>
			</header>

			{
				!authenticated ? (
					<div class="auth-required">
						<h2>Authentication Required</h2>
						<p>Please sign in to access this editor test page.</p>
						<a href="/sign-in" class="btn btn-primary">
							Sign In
						</a>
					</div>
				) : !hasContentPermissions ? (
					<div class="access-denied">
						<h2>Content Permissions Required</h2>
						<p>
							Your current role ({userRole}) does not have content creation or
							editing permissions. This page requires editor-level access.
						</p>
						<p>
							<strong>Your permissions:</strong>{' '}
							{userPermissions.length > 0 ? userPermissions.join(', ') : 'None'}
						</p>
						<div class="suggestion">
							<p>
								<strong>Required permissions:</strong> write_content or
								edit_content
							</p>
							<p>
								<strong>Available roles with these permissions:</strong> editor,
								admin
							</p>
						</div>
						<a href="/test/menu" class="btn btn-secondary">
							Back to Menu Test
						</a>
					</div>
				) : (
					<div class="editor-content">
						<div class="user-info">
							<h2>Current User Information</h2>
							<div class="info-grid">
								<div class="info-item">
									<strong>Role:</strong> {userRole}
								</div>
								<div class="info-item">
									<strong>Permissions:</strong> {userPermissions.join(', ')}
								</div>
								<div class="info-item">
									<strong>Can Write:</strong>{' '}
									{canWriteContent(Astro.locals) ? 'Yes' : 'No'}
								</div>
								<div class="info-item">
									<strong>Can Edit:</strong>{' '}
									{canEditContent(Astro.locals) ? 'Yes' : 'No'}
								</div>
							</div>
						</div>

						<div class="demo-section">
							<h2>Editor Menu Navigation</h2>
							<p>
								This menu shows editor-specific navigation options for content
								management:
							</p>
							<div class="menu-demo">
								<PermissionMenu
									items={editorMenu}
									className="editor-navigation"
								/>
							</div>
						</div>

						<div class="demo-section">
							<h2>Content Management Actions</h2>
							<p>
								These actions are available based on your content permissions:
							</p>
							<div class="content-actions">
								{canWriteContent(Astro.locals) && (
									<div class="action-group">
										<h3>Writing Permissions</h3>
										<button type="button" class="btn btn-success">
											Create New Article
										</button>
										<button type="button" class="btn btn-info">
											Save Draft
										</button>
										<button type="button" class="btn btn-warning">
											Submit for Review
										</button>
									</div>
								)}

								{canEditContent(Astro.locals) && (
									<div class="action-group">
										<h3>Editing Permissions</h3>
										<button type="button" class="btn btn-primary">
											Edit Published Content
										</button>
										<button type="button" class="btn btn-info">
											Review Submissions
										</button>
										<button type="button" class="btn btn-success">
											Approve for Publishing
										</button>
									</div>
								)}

								{!canManageUser(Astro.locals) && (
									<div class="action-group disabled">
										<h3>Admin-Only Actions (Not Available)</h3>
										<button type="button" class="btn btn-disabled" disabled>
											Manage Users
										</button>
										<button type="button" class="btn btn-disabled" disabled>
											System Settings
										</button>
										<button type="button" class="btn btn-disabled" disabled>
											Delete Any Content
										</button>
									</div>
								)}
							</div>
						</div>

						<div class="demo-section">
							<h2>Permission-Based Components</h2>
							<p>The following component demonstrates conditional rendering:</p>
							<PermissionExample />
						</div>

						<div class="demo-section">
							<h2>Content Workflow Simulation</h2>
							<p>
								This simulates a typical content creation and editing workflow:
							</p>
							<div class="workflow">
								<div class="workflow-step">
									<div class="step-number">1</div>
									<div class="step-content">
										<h4>Create Content</h4>
										<p>
											{canWriteContent(Astro.locals)
												? '✅ You can create new content'
												: '❌ Write permission required'}
										</p>
									</div>
								</div>
								<div class="workflow-step">
									<div class="step-number">2</div>
									<div class="step-content">
										<h4>Edit & Review</h4>
										<p>
											{canEditContent(Astro.locals)
												? '✅ You can edit and review content'
												: '❌ Edit permission required'}
										</p>
									</div>
								</div>
								<div class="workflow-step">
									<div class="step-number">3</div>
									<div class="step-content">
										<h4>Publish</h4>
										<p>
											{canEditContent(Astro.locals)
												? '✅ You can publish content'
												: '❌ Edit permission required'}
										</p>
									</div>
								</div>
							</div>
						</div>

						<div class="demo-section">
							<h2>Standard Menu Example</h2>
							<p>This shows how the standard menu appears for editor users:</p>
							<MenuExample />
						</div>

						<div class="demo-section">
							<h2>Test Other Roles</h2>
							<p>Compare editor access with other role levels:</p>
							<div class="role-links">
								<a href="/test/admin" class="btn btn-outline">
									Admin Test Page
								</a>
								<a href="/test/viewer" class="btn btn-outline">
									Viewer Test Page
								</a>
								<a href="/test/menu" class="btn btn-outline">
									Menu Test Page
								</a>
							</div>
						</div>
					</div>
				)
			}
		</div>
	</div>
</Layout>

<style>
	.editor-test-page {
		min-height: 100vh;
		background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
		padding: 2rem 0;
	}

	.container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 1rem;
	}

	.page-header {
		text-align: center;
		margin-bottom: 3rem;
		color: white;
	}

	.page-header h1 {
		font-size: 3rem;
		margin-bottom: 0.5rem;
		text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
	}

	.subtitle {
		font-size: 1.2rem;
		opacity: 0.9;
		margin: 0;
	}

	.auth-required,
	.access-denied {
		background: white;
		padding: 2rem;
		border-radius: 1rem;
		text-align: center;
		box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
	}

	.suggestion {
		background: #f8f9fa;
		padding: 1rem;
		border-radius: 0.5rem;
		margin: 1rem 0;
		border-left: 4px solid #17a2b8;
	}

	.editor-content {
		background: white;
		border-radius: 1rem;
		padding: 2rem;
		box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
	}

	.user-info {
		background: #f8f9fa;
		padding: 1.5rem;
		border-radius: 0.5rem;
		margin-bottom: 2rem;
		border-left: 4px solid #28a745;
	}

	.info-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 1rem;
		margin-top: 1rem;
	}

	.info-item {
		padding: 0.5rem;
		background: white;
		border-radius: 0.25rem;
		border: 1px solid #dee2e6;
	}

	.demo-section {
		margin-bottom: 2.5rem;
		padding-bottom: 2rem;
		border-bottom: 1px solid #e9ecef;
	}

	.demo-section:last-child {
		border-bottom: none;
		margin-bottom: 0;
	}

	.demo-section h2 {
		color: #495057;
		margin-bottom: 1rem;
		font-size: 1.5rem;
	}

	.menu-demo {
		background: #f8f9fa;
		padding: 1.5rem;
		border-radius: 0.5rem;
		border: 1px solid #dee2e6;
	}

	.content-actions {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 1.5rem;
		margin-top: 1rem;
	}

	.action-group {
		background: #f8f9fa;
		padding: 1.5rem;
		border-radius: 0.5rem;
		border: 1px solid #dee2e6;
	}

	.action-group.disabled {
		opacity: 0.6;
		background: #f1f3f4;
	}

	.action-group h3 {
		margin-top: 0;
		margin-bottom: 1rem;
		color: #495057;
		font-size: 1.1rem;
	}

	.action-group .btn {
		display: block;
		width: 100%;
		margin-bottom: 0.5rem;
	}

	.action-group .btn:last-child {
		margin-bottom: 0;
	}

	.workflow {
		display: flex;
		flex-direction: column;
		gap: 1rem;
		margin-top: 1rem;
	}

	.workflow-step {
		display: flex;
		align-items: center;
		background: #f8f9fa;
		padding: 1rem;
		border-radius: 0.5rem;
		border: 1px solid #dee2e6;
	}

	.step-number {
		width: 40px;
		height: 40px;
		background: #28a745;
		color: white;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-weight: bold;
		margin-right: 1rem;
		flex-shrink: 0;
	}

	.step-content h4 {
		margin: 0 0 0.5rem 0;
		color: #495057;
	}

	.step-content p {
		margin: 0;
		font-size: 0.9rem;
	}

	.role-links {
		display: flex;
		flex-wrap: wrap;
		gap: 1rem;
		margin-top: 1rem;
	}

	/* Button styles */
	.btn {
		display: inline-block;
		padding: 0.75rem 1.5rem;
		border: none;
		border-radius: 0.5rem;
		text-decoration: none;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s ease;
		text-align: center;
	}

	.btn-primary {
		background: #007bff;
		color: white;
	}

	.btn-primary:hover {
		background: #0056b3;
	}

	.btn-secondary {
		background: #6c757d;
		color: white;
	}

	.btn-secondary:hover {
		background: #545b62;
	}

	.btn-success {
		background: #28a745;
		color: white;
	}

	.btn-success:hover {
		background: #218838;
	}

	.btn-info {
		background: #17a2b8;
		color: white;
	}

	.btn-info:hover {
		background: #138496;
	}

	.btn-warning {
		background: #ffc107;
		color: #212529;
	}

	.btn-warning:hover {
		background: #e0a800;
	}

	.btn-outline {
		background: transparent;
		color: #007bff;
		border: 2px solid #007bff;
	}

	.btn-outline:hover {
		background: #007bff;
		color: white;
	}

	.btn-disabled {
		background: #e9ecef;
		color: #6c757d;
		cursor: not-allowed;
	}

	/* Global menu styling */
	:global(.editor-navigation) {
		background: white;
		border: 1px solid #dee2e6;
		border-radius: 0.5rem;
		overflow: hidden;
	}

	:global(.editor-navigation .menu-link) {
		border-bottom: 1px solid #f8f9fa;
	}

	:global(.editor-navigation .menu-link:hover) {
		background: #e9ecef;
	}

	/* Responsive design */
	@media (max-width: 768px) {
		.page-header h1 {
			font-size: 2rem;
		}

		.content-actions {
			grid-template-columns: 1fr;
		}

		.role-links {
			flex-direction: column;
		}

		.info-grid {
			grid-template-columns: 1fr;
		}

		.workflow {
			gap: 0.5rem;
		}

		.workflow-step {
			flex-direction: column;
			text-align: center;
		}

		.step-number {
			margin-right: 0;
			margin-bottom: 0.5rem;
		}
	}
</style>
