---
/**
 * Admin Test Page
 *
 * Demonstrates admin-only functionality and full permission access.
 * This page showcases all available RBAC features for users with admin role.
 */

import Layout from '@/layouts/Layout.astro';
import { Button } from '@/components/ui/button';
import TitleBar from '@/components/site/TitleBar.astro';
import PermissionExample from '@/components/auth/PermissionExample.astro';
import MenuExample from '@/components/auth/MenuExample.astro';
import PermissionMenu from '@/components/auth/PermissionMenu.astro';
import TemplateUtilityDemo from '@/components/auth/TemplateUtilityDemo.astro';
import {
	canWriteContent,
	canEditContent,
	canManageUser,
	isAdmin,
	isAuthenticated,
	getUserRoleTemplate as getUserRole,
	getUserPermissionsTemplate as getUserPermissions,
} from '@/lib/auth';
import type { MenuItem, PageMeta } from '@/types';

// Page metadata
const pageMeta: PageMeta = {
	title: 'Admin Test Page - RBAC Demo',
	description:
		'Demonstration of admin-level access and permissions in the RBAC system',
	language: 'en',
};

// Get user context
const userRole = getUserRole(Astro.locals);
const userPermissions = getUserPermissions(Astro.locals);
const authenticated = isAuthenticated(Astro.locals);
const adminAccess = isAdmin(Astro.locals);

// Admin-specific menu configuration
const adminMenu: MenuItem[] = [
	{
		label: 'Dashboard',
		href: '/a',
		permissions: ['manage_user'],
	},
	{
		label: 'User Management',
		href: '/a/users',
		permissions: ['manage_user'],
		children: [
			{
				label: 'View All Users',
				href: '/a/users/list',
				permissions: ['manage_user'],
			},
			{
				label: 'Create User',
				href: '/a/users/create',
				permissions: ['manage_user'],
			},
			{
				label: 'User Roles',
				href: '/a/users/roles',
				permissions: ['manage_user'],
			},
			{
				label: 'Permissions',
				href: '/a/users/permissions',
				permissions: ['manage_user'],
			},
		],
	},
	{
		label: 'Content Management',
		href: '/a/content',
		permissions: ['edit_content', 'write_content'],
		children: [
			{
				label: 'All Content',
				href: '/a/content/all',
				permissions: ['edit_content'],
			},
			{
				label: 'Pending Review',
				href: '/a/content/pending',
				permissions: ['edit_content'],
			},
			{
				label: 'Published',
				href: '/a/content/published',
				permissions: ['edit_content'],
			},
		],
	},
	{
		label: 'System Settings',
		href: '/a/settings',
		permissions: ['manage_user'],
		children: [
			{
				label: 'General',
				href: '/a/settings/general',
				permissions: ['manage_user'],
			},
			{
				label: 'Security',
				href: '/a/settings/security',
				permissions: ['manage_user'],
			},
			{
				label: 'Integrations',
				href: '/a/settings/integrations',
				permissions: ['manage_user'],
			},
		],
	},
];
---

<Layout pageMeta={pageMeta}>
	<TitleBar
		breadcrumbs={[
			{ title: 'Home', url: '/' },
			{ title: 'Test', url: '/test' },
			{ title: pageMeta.title, url: '' },
		]}
		description={pageMeta.description}
		title={pageMeta.title}
	/>

	<div class="container">
		{
			!authenticated ? (
				<>
					<h2 class="text-2xl font-semibold mb-4">Authentication Required</h2>
					<p class="mb-6">Please sign in to access this admin test page.</p>
					<Button variant="default">
						<a href="/sign-in">Sign In</a>
					</Button>
				</>
			) : !adminAccess ? (
				<>
					<h2 class="text-2xl font-semibold mb-4">Admin Access Required</h2>
					<p class="mb-6">
						Your current role ({userRole}) does not have admin privileges. This
						page requires admin role to access.
					</p>
					<p class="mb-6">
						<strong>Your permissions:</strong>{' '}
						{userPermissions.length > 0 ? userPermissions.join(', ') : 'None'}
					</p>
					<Button variant="default">
						<a href="/test/menu">Back to Menu Test</a>
					</Button>
				</>
			) : (
				<>
					{/* Current User Information */}
					<div class="mb-10 pb-8">
						<h2 class="text-2xl font-semibold mb-4">Admin Menu Navigation</h2>
						<p class="mb-6">
							Quick overview of current user's role and permissions
						</p>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
							<div class="p-3 bg-foreground/5 rounded border">
								<strong class="">Role:</strong> <span>{userRole}</span>
							</div>
							<div class="p-3 bg-foreground/5 rounded border">
								<strong class="">Permissions:</strong>{' '}
								{/* <code>{userPermissions.join(', ')}</code> */}
								{/* <span class="font-mono bg-foreground/10 px-2 py-1 rounded text-sm leading-8 flex gap-2"> */}
								<span class="text-sm flex gap-2">
									{userPermissions.length > 0
										? userPermissions.map((permission) => (
												<code class="rounded font-mono bg-foreground/10 px-1">
													{permission}
												</code>
											))
										: 'None'}
								</span>
							</div>
							<div class="p-3 bg-foreground/5 rounded border">
								<strong class="">Admin Access:</strong>{' '}
								<span>{adminAccess ? 'Yes' : 'No'}</span>
							</div>
						</div>
					</div>
					{/* <div class="bg-foreground/5 p-6 rounded mb-8">
						<h2 class="text-xl font-semibold mb-4 ">
							Current User Information
						</h2>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
							<div class="p-3 bg-foreground/10 rounded border">
								<strong class="">Role:</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">{userRole}</span>
							</div>
							<div class="p-3 bg-foreground/10 rounded border">
								<strong class="">Permissions:</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">
									{userPermissions.join(', ')}
								</span>
							</div>
							<div class="p-3 bg-foreground/10 rounded border">
								<strong class="">Admin Access:</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">
									{adminAccess ? 'Yes' : 'No'}
								</span>
							</div>
						</div>
					</div> */}
					{/* Admin Menu Navigation */}
					<div class="mb-10 pb-8">
						<h2 class="text-2xl font-semibold mb-4">Admin Menu Navigation</h2>
						<p class="mb-6">
							This menu shows admin-specific navigation options with nested
							permission requirements:
						</p>
						<div class="bg-foreground/5 p-6 rounded border">
							<PermissionMenu items={adminMenu} className="admin-navigation" />
						</div>
					</div>
					{/* Permission-Based Components */}
					<div class="mb-10 pb-8">
						<h2 class="text-2xl font-semibold mb-4">
							Permission-Based Components
						</h2>
						<p class="mb-6">
							The following component demonstrates conditional rendering based
							on permissions:
						</p>
						<PermissionExample />
					</div>
					{/* Admin Actions */}
					<div class="mb-10 pb-8">
						<h2 class="text-2xl font-semibold mb-4">Admin Actions</h2>
						<p class="mb-6">
							These actions are only available to users with admin permissions:
						</p>
						<div class="p-4 border rounded my-4 bg-foreground/5">
							{canManageUser(Astro.locals) && (
								<Button class="px-6 py-3 bg-red-500 dark:bg-red-600 text-white  font-medium hover:bg-red-600 dark:hover:bg-red-700 transition-colors border-0 cursor-pointer">
									Delete User Account
								</Button>
							)}
							{canManageUser(Astro.locals) && (
								<Button class="px-6 py-3 bg-yellow-500 dark:bg-yellow-600 text-white  font-medium hover:bg-yellow-600 dark:hover:bg-yellow-700 transition-colors border-0 cursor-pointer">
									Modify User Roles
								</Button>
							)}
							{canEditContent(Astro.locals) && (
								<Button class="px-6 py-3 bg-cyan-500 dark:bg-cyan-600 text-white  font-medium hover:bg-cyan-600 dark:hover:bg-cyan-700 transition-colors border-0 cursor-pointer">
									Moderate All Content
								</Button>
							)}
							{canWriteContent(Astro.locals) && (
								<Button class="px-6 py-3 bg-green-500 dark:bg-green-600 text-white  font-medium hover:bg-green-600 dark:hover:bg-green-700 transition-colors border-0 cursor-pointer">
									Create System Announcements
								</Button>
							)}
						</div>
					</div>
					{/* Standard Menu Example */}
					<div class="mb-10 pb-8">
						<h2 class="text-2xl font-semibold mb-4">Standard Menu Example</h2>
						<p class="mb-6">
							This shows how the standard menu appears for admin users:
						</p>
						<MenuExample />
					</div>
					{/* Template Utility Functions */}
					<div class="mb-10 pb-8">
						<h2 class="text-2xl font-semibold mb-4">
							Template Utility Functions
						</h2>
						<p class="mb-6">
							Comprehensive demonstration of all RBAC template utilities:
						</p>
						<TemplateUtilityDemo />
					</div>

					{/* Test Other Roles */}
					<div class="mb-10 pb-8">
						<h2 class="text-2xl font-semibold mb-4">Test Other Roles</h2>
						<p class="mb-6">Compare admin access with other role levels:</p>
						<div class="flex flex-wrap gap-4 mt-4">
							<Button variant="outline">
								<a href="/test/editor">Editor Test Page</a>
							</Button>
							<Button variant="outline">
								<a href="/test/viewer">Viewer Test Page</a>
							</Button>
							<Button variant="outline">
								<a href="/test/menu">Menu Test Page</a>
							</Button>
						</div>
					</div>
				</>
			)
		}
	</div>
</Layout>
