---
/**
 * Viewer Test Page
 *
 * Demonstrates viewer-level functionality with minimal permissions.
 * This page showcases RBAC features for users with viewer role (no special permissions).
 */

import Layout from '@/layouts/Layout.astro';
import PermissionExample from '@/components/auth/PermissionExample.astro';
import MenuExample from '@/components/auth/MenuExample.astro';
import PermissionMenu from '@/components/auth/PermissionMenu.astro';
import {
	canWriteContent,
	canEditContent,
	canManageUser,
	hasRole,
	isAuthenticated,
	getUserRoleTemplate as getUserRole,
	getUserPermissionsTemplate as getUserPermissions,
} from '@/lib/auth';
import type { MenuItem, PageMeta } from '@/types';

// Page metadata
const pageMeta: PageMeta = {
	title: 'Viewer Test Page - RBAC Demo',
	description:
		'Demonstration of viewer-level access with minimal permissions in the RBAC system',
	language: 'en',
};

// Get user context
const userRole = getUserRole(Astro.locals);
const userPermissions = getUserPermissions(Astro.locals);
const authenticated = isAuthenticated(Astro.locals);
const isViewer = hasRole(Astro.locals, 'viewer');

// Viewer-accessible menu configuration (public/general access items)
const viewerMenu: MenuItem[] = [
	{
		label: 'Home',
		href: '/',
		// No permissions - accessible to all authenticated users
	},
	{
		label: 'Browse Content',
		href: '/browse',
		// No permissions - public content browsing
		children: [
			{
				label: 'Articles',
				href: '/browse/articles',
			},
			{
				label: 'Categories',
				href: '/browse/categories',
			},
			{
				label: 'Popular',
				href: '/browse/popular',
			},
		],
	},
	{
		label: 'My Account',
		href: '/account',
		// No permissions - basic account access
		children: [
			{
				label: 'Profile',
				href: '/account/profile',
			},
			{
				label: 'Settings',
				href: '/account/settings',
			},
			{
				label: 'Preferences',
				href: '/account/preferences',
			},
		],
	},
	{
		label: 'Help & Support',
		href: '/help',
		// No permissions - public help section
		children: [
			{
				label: 'FAQ',
				href: '/help/faq',
			},
			{
				label: 'Contact',
				href: '/help/contact',
			},
			{
				label: 'Documentation',
				href: '/help/docs',
			},
		],
	},
];

// Restricted menu items that viewers cannot access
const restrictedItems = [
	{ label: 'Create Content', permission: 'write_content' },
	{ label: 'Edit Content', permission: 'edit_content' },
	{ label: 'Manage Users', permission: 'manage_user' },
	{ label: 'Admin Panel', permission: 'manage_user' },
	{ label: 'Content Moderation', permission: 'edit_content' },
	{ label: 'System Settings', permission: 'manage_user' },
];
---

<Layout pageMeta={pageMeta}>
	<div class="container">
		<header class="text-center mb-12 text-white">
			<h1 class="text-5xl font-bold mb-2 drop-shadow-lg">Viewer Test Page</h1>
			<p class="text-xl opacity-90 m-0">
				Demonstrating viewer-level access with minimal permissions
			</p>
		</header>

		{
			!authenticated ? (
				<div class="bg-white dark:bg-gray-800 p-8 rounded-2xl text-center shadow-2xl">
					<h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-gray-100">
						Authentication Required
					</h2>
					<p class="mb-6 text-gray-700 dark:text-gray-300">
						Please sign in to access this viewer test page.
					</p>
					<a
						href="/sign-in"
						class="inline-block px-6 py-3 bg-blue-500 dark:bg-blue-600 text-white  font-medium hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors no-underline"
					>
						Sign In
					</a>
				</div>
			) : (
				<div class="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-2xl">
					<div class="bg-blue-50 dark:bg-blue-900/30 p-6  mb-8 border-l-4 border-blue-500">
						<h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">
							Current User Information
						</h2>
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
							<div class="p-3 bg-white dark:bg-gray-600 rounded border border-blue-200 dark:border-gray-500">
								<strong class="text-gray-900 dark:text-gray-100">Role:</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">{userRole}</span>
							</div>
							<div class="p-3 bg-white dark:bg-gray-600 rounded border border-blue-200 dark:border-gray-500">
								<strong class="text-gray-900 dark:text-gray-100">
									Permissions:
								</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">
									{userPermissions.length > 0
										? userPermissions.join(', ')
										: 'None (viewer role)'}
								</span>
							</div>
							<div class="p-3 bg-white dark:bg-gray-600 rounded border border-blue-200 dark:border-gray-500">
								<strong class="text-gray-900 dark:text-gray-100">
									Access Level:
								</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">Read-only</span>
							</div>
							<div class="p-3 bg-white dark:bg-gray-600 rounded border border-blue-200 dark:border-gray-500">
								<strong class="text-gray-900 dark:text-gray-100">
									Account Type:
								</strong>{' '}
								<span class="text-gray-700 dark:text-gray-300">
									Standard User
								</span>
							</div>
						</div>
					</div>

					<div class="demo-section">
						<h2>Available Navigation</h2>
						<p>
							This menu shows what's accessible to viewer-level users (no
							special permissions required):
						</p>
						<div class="menu-demo">
							<PermissionMenu
								items={viewerMenu}
								className="viewer-navigation"
							/>
						</div>
					</div>

					<div class="demo-section">
						<h2>Permission Status</h2>
						<p>Here's what you can and cannot do with viewer-level access:</p>
						<div class="permission-status">
							<div class="status-section allowed">
								<h3>✅ What You Can Do</h3>
								<ul>
									<li>Browse and read all public content</li>
									<li>Access your account settings</li>
									<li>View help and documentation</li>
									<li>Search and filter content</li>
									<li>Update your profile information</li>
									<li>Change account preferences</li>
								</ul>
							</div>

							<div class="status-section restricted">
								<h3>❌ What You Cannot Do</h3>
								<ul>
									{restrictedItems.map((item) => (
										<li>
											{item.label} (requires {item.permission} permission)
										</li>
									))}
								</ul>
							</div>
						</div>
					</div>

					<div class="demo-section">
						<h2>Action Buttons Demo</h2>
						<p>These buttons demonstrate permission-based visibility:</p>
						<div class="action-demo">
							<div class="available-actions">
								<h4>Available Actions</h4>
								<button type="button" class="btn btn-primary">
									View Content
								</button>
								<button type="button" class="btn btn-info">
									Search
								</button>
								<button type="button" class="btn btn-secondary">
									Update Profile
								</button>
							</div>

							<div class="restricted-actions">
								<h4>Restricted Actions (Not Visible/Disabled)</h4>
								{!canWriteContent(Astro.locals) && (
									<button type="button" class="btn btn-disabled" disabled>
										Create Content (requires write_content)
									</button>
								)}
								{!canEditContent(Astro.locals) && (
									<button type="button" class="btn btn-disabled" disabled>
										Edit Content (requires edit_content)
									</button>
								)}
								{!canManageUser(Astro.locals) && (
									<button type="button" class="btn btn-disabled" disabled>
										Manage Users (requires manage_user)
									</button>
								)}
							</div>
						</div>
					</div>

					<div class="demo-section">
						<h2>Permission-Based Components</h2>
						<p>
							The following component shows how content adapts to your
							permission level:
						</p>
						<PermissionExample />
					</div>

					<div class="demo-section">
						<h2>Standard Menu Example</h2>
						<p>This shows how the standard menu appears for viewer users:</p>
						<MenuExample />
					</div>

					<div class="demo-section">
						<h2>Role Upgrade Information</h2>
						<div class="upgrade-info">
							<h3>Want More Access?</h3>
							<p>
								Your current viewer role provides read-only access. To get
								additional permissions, you would need:
							</p>
							<div class="role-comparison">
								<div class="role-card">
									<h4>Editor Role</h4>
									<p>
										<strong>Additional permissions:</strong>
									</p>
									<ul>
										<li>write_content - Create new content</li>
										<li>edit_content - Modify existing content</li>
									</ul>
									<p>
										<strong>Capabilities:</strong>
									</p>
									<ul>
										<li>Create articles and posts</li>
										<li>Edit and publish content</li>
										<li>Manage content workflow</li>
									</ul>
								</div>
								<div class="role-card">
									<h4>Admin Role</h4>
									<p>
										<strong>All permissions:</strong>
									</p>
									<ul>
										<li>write_content - Create content</li>
										<li>edit_content - Edit content</li>
										<li>manage_user - User management</li>
									</ul>
									<p>
										<strong>Capabilities:</strong>
									</p>
									<ul>
										<li>Full content management</li>
										<li>User account management</li>
										<li>System administration</li>
									</ul>
								</div>
							</div>
						</div>
					</div>

					<div class="demo-section">
						<h2>Test Other Roles</h2>
						<p>
							Compare viewer access with higher privilege levels (note: you may
							get access denied):
						</p>
						<div class="role-links">
							<a href="/test/editor" class="btn btn-outline">
								Editor Test Page
							</a>
							<a href="/test/a" class="btn btn-outline">
								Admin Test Page
							</a>
							<a href="/test/menu" class="btn btn-outline">
								Menu Test Page
							</a>
						</div>
					</div>
				</div>
			)
		}
	</div>
</Layout>
