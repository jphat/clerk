---
/**
 * Viewer Test Page
 *
 * Demonstrates viewer-level functionality with minimal permissions.
 * This page showcases RBAC features for users with viewer role (no special permissions).
 */

import { Check, X } from 'lucide-vue-next';
import Layout from '@/layouts/Layout.astro';
import { Button } from '@/components/ui/button';
import PermissionExample from '@/components/auth/PermissionExample.astro';
import MenuExample from '@/components/auth/MenuExample.astro';
import PermissionMenu from '@/components/auth/PermissionMenu.astro';
import TitleBar from '@/components/site/TitleBar.astro';
import {
	canWriteContent,
	canEditContent,
	canManageUser,
	// hasRole,
	isAuthenticated,
	getUserRoleTemplate as getUserRole,
	getUserPermissionsTemplate as getUserPermissions,
} from '@/lib/auth';
import type { MenuItem, PageMeta } from '@/types';

// Page metadata
const pageMeta: PageMeta = {
	title: 'Viewer Test Page - RBAC Demo',
	description:
		'Demonstration of viewer-level access with minimal permissions in the RBAC system',
	language: 'en',
};

// Get user context
const userRole = getUserRole(Astro.locals);
const userPermissions = getUserPermissions(Astro.locals);
const authenticated = isAuthenticated(Astro.locals);
// const isViewer = hasRole(Astro.locals, 'viewer');

// Viewer-accessible menu configuration (public/general access items)
const viewerMenu: MenuItem[] = [
	{
		label: 'Home',
		href: '/',
		// No permissions - accessible to all authenticated users
	},
	{
		label: 'Browse Content',
		href: '/browse',
		// No permissions - public content browsing
		children: [
			{
				label: 'Articles',
				href: '/browse/articles',
			},
			{
				label: 'Categories',
				href: '/browse/categories',
			},
			{
				label: 'Popular',
				href: '/browse/popular',
			},
		],
	},
	{
		label: 'My Account',
		href: '/account',
		// No permissions - basic account access
		children: [
			{
				label: 'Profile',
				href: '/account/profile',
			},
			{
				label: 'Settings',
				href: '/account/settings',
			},
			{
				label: 'Preferences',
				href: '/account/preferences',
			},
		],
	},
	{
		label: 'Help & Support',
		href: '/help',
		// No permissions - public help section
		children: [
			{
				label: 'FAQ',
				href: '/help/faq',
			},
			{
				label: 'Contact',
				href: '/help/contact',
			},
			{
				label: 'Documentation',
				href: '/help/docs',
			},
		],
	},
];

// Restricted menu items that viewers cannot access
const restrictedItems = [
	{ label: 'Create Content', permission: 'write_content' },
	{ label: 'Edit Content', permission: 'edit_content' },
	{ label: 'Manage Users', permission: 'manage_user' },
	{ label: 'Admin Panel', permission: 'manage_user' },
	{ label: 'Content Moderation', permission: 'edit_content' },
	{ label: 'System Settings', permission: 'manage_user' },
];
---

<Layout pageMeta={pageMeta}>
	<TitleBar
		breadcrumbs={[
			{ title: 'Home', url: '/' },
			{ title: 'Test', url: '/test' },
			{ title: pageMeta.title, url: '' },
		]}
		description={pageMeta.description}
		title={pageMeta.title}
	/>

	<div class="container"></div>

	<div class="container">
		{
			!authenticated ? (
				<>
					<h2 class="text-2xl font-semibold mb-4">Authentication Required</h2>
					<p class="mb-6">Please sign in to access this viewer test page.</p>
					<Button variant="default">
						<a href="/sign-in"> Sign In </a>
					</Button>
				</>
			) : (
				<>
					{/* Current User Information */}
					{/* TODO: componentize */}
					<div class="border mb-10 p-6">
						<h2 class="text-2xl font-semibold mb-4">
							Current User Information
						</h2>
						<p> Quick overview of current user's role and permissions </p>
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
							<div class="p-3  rounded border bg-foreground/5 ">
								<strong>Role:</strong> <span>{userRole}</span>
							</div>
							<div class="p-3  rounded border bg-foreground/5 ">
								<strong>Permissions:</strong> {/* TODO: componentize */}
								<span class="text-sm gap-2">
									{userPermissions.length > 0
										? userPermissions.map((permission) => (
												<code class="rounded font-mono bg-foreground/10 px-1 mx-1 inline-block">
													{permission}
												</code>
											))
										: 'None'}
								</span>
							</div>
							<div class="p-3  rounded border bg-foreground/5 ">
								{/* TODO: check actual */}
								{/* <strong >Can Write:</strong>{' '}
								<span >
									{canWriteContent(Astro.locals) ? 'Yes' : 'No'}
								</span> */}
								<strong>Access Level:</strong> <span>Read-only</span>
							</div>
							<div class="p-3  rounded border bg-foreground/5 ">
								{/* <strong >Can Edit:</strong>{' '}
								<span >
									{canEditContent(Astro.locals) ? 'Yes' : 'No'}
								</span> */}
								<strong>Account Type:</strong> <span>Standard User</span>
							</div>
						</div>
					</div>

					{/* Available Navigation */}
					<div class="border mb-10 p-6">
						<h2 class="text-2xl font-semibold mb-4">Available Navigation</h2>
						<p class=" mb-6">
							This menu shows what's accessible to viewer-level users (no
							special permissions required):
						</p>
						<div class="menu-demo">
							<PermissionMenu
								items={viewerMenu}
								className="viewer-navigation"
							/>
						</div>
					</div>

					{/* Permission Status */}
					<div class="border mb-10 p-6">
						<h2 class="text-2xl font-semibold mb-4">Permission Status</h2>
						<p>Here's what you can and cannot do with viewer-level access:</p>
						<div class="mt-4">
							<h3 class="font-semibold text-lg flex gap-2">
								<Check class="stroke-green-600" /> What You Can Do
							</h3>
							<ul class="space-y-4 list-disc ml-4">
								<li>Browse and read all public content</li>
								<li>Access your account settings</li>
								<li>View help and documentation</li>
								<li>Search and filter content</li>
								<li>Update your profile information</li>
								<li>Change account preferences</li>
							</ul>
						</div>

						<div class="mt-4">
							<h3 class="font-semibold text-lg flex  gap-2">
								<X class="stroke-destructive" /> What You Cannot Do
							</h3>
							<ul class="space-y-4 list-disc ml-4">
								{restrictedItems.map((item) => (
									<li>
										{item.label} (requires {item.permission} permission)
									</li>
								))}
							</ul>
						</div>
					</div>

					{/* Action Buttons Demo */}
					<div class="border mb-10 p-6">
						<h2 class="text-2xl font-semibold mb-4">Action Buttons Demo</h2>
						<p class=" mb-6">
							These buttons demonstrate permission-based visibility:
						</p>
						<h3 class="text-lg font-semibold mb-6">Available Actions</h3>
						<buttonButton variant="outline">View Content</buttonButton>
						<Button variant="outline">Search</Button>
						<Button variant="outline">Update Profile</Button>

						<h3 class="text-lg font-semibold my-6">
							Restricted Actions (Not Visible/Disabled)
						</h3>
						{!canWriteContent(Astro.locals) && (
							<Button variant="outline">
								Create Content (requires write_content)
							</Button>
						)}
						{!canEditContent(Astro.locals) && (
							<Button variant="outline">
								Edit Content (requires edit_content)
							</Button>
						)}
						{!canManageUser(Astro.locals) && (
							<Button variant="outline">
								Manage Users (requires manage_user)
							</Button>
						)}
					</div>

					{/* Permission-Based Components */}
					<div class="border mb-10 p-6">
						<h2 class="text-2xl font-semibold mb-4">
							Permission-Based Components
						</h2>
						<p class=" mb-6">
							The following component shows how content adapts to your
							permission level:
						</p>
						<PermissionExample />
					</div>

					{/* Standard Menu Example */}
					<div class="border mb-10 p-6">
						<h2 class="text-2xl font-semibold mb-4">Standard Menu Example</h2>
						<p class="mb-6">
							This shows how the standard menu appears for viewer users:
						</p>
						<MenuExample />
					</div>

					{/* Role Upgrade Information */}
					<div class="border mb-10 p-6">
						<h2 class="text-2xl font-semibold mb-4">
							Role Upgrade Information
						</h2>
						<div class="space-y-4">
							<h3 class="text-lg font-semibold">Want More Access?</h3>
							<p>
								Your current viewer role provides read-only access. To get
								additional permissions, you would need:
							</p>

							<h4 class="font-semibold">Editor Role</h4>
							<p>
								<strong>Additional permissions:</strong>
							</p>
							<ul class="ml-6">
								<li>write_content - Create new content</li>
								<li>edit_content - Modify existing content</li>
							</ul>
							<p>
								<strong>Capabilities:</strong>
							</p>
							<ul class="ml-6">
								<li>Create articles and posts</li>
								<li>Edit and publish content</li>
								<li>Manage content workflow</li>
							</ul>

							<h4 class="font-semibold">Admin Role</h4>
							<p>
								<strong>All permissions:</strong>
							</p>
							<ul class="ml-6">
								<li>write_content - Create content</li>
								<li>edit_content - Edit content</li>
								<li>manage_user - User management</li>
							</ul>
							<p>
								<strong>Capabilities:</strong>
							</p>
							<ul class="ml-6">
								<li>Full content management</li>
								<li>User account management</li>
								<li>System administration</li>
							</ul>
						</div>
					</div>

					<div class="border mb-10 p-6">
						<h2 class="text-2xl font-semibold mb-4">Test Other Roles</h2>
						<p class="mb-6">
							Compare viewer access with higher privilege levels (note: you may
							get access denied):
						</p>
						<div class="role-links">
							<Button variant="outline">
								<a href="/test/editor">Editor Test Page</a>
							</Button>
							<Button variant="outline">
								<a href="/test/admin">Admin Test Page</a>
							</Button>
							<Button variant="outline">
								<a href="/test/menu">Menu Test Page</a>
							</Button>
						</div>
					</div>
				</>
			)
		}
	</div>
</Layout>
